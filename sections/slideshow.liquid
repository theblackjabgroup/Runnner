<section class="multi-layer-scroll">
  <!-- Intro Section -->
  <div class="intro" id="intro">
    <div class="intro-content">
      <h1 class="letter-slide">
        {{ section.settings.intro_title | default: 'MISSION' }}
      </h1>
      <p class="intro-subtext">
        {{ section.settings.intro_subtext | default: 'EVOLVE THE FULL EXPERIENCE OF RUNNING' }}
      </p>
    </div>

    <div class="carousel">
      <div class="carousel-track" id="intro-carousel">
        {% assign carousel_blocks = section.blocks | where: 'type', 'carousel_image' %}
        {% if carousel_blocks.size > 0 %}
          {% for b in carousel_blocks %}
            {% if b.settings.image != blank %}
              <img
                class="carousel-img"
                src="{{ b.settings.image | image_url: width: 2000 }}"
                alt="{{ b.settings.alt | escape | default: 'Intro image ' | append: forloop.index }}"
                height="600"
                width="1000"
              >
            {% endif %}
          {% endfor %}
        {% else %}
          <!-- Fallback images -->
          <img
            class="carousel-img"
            src="https://images.unsplash.com/photo-1479064555552-3ef4979f8908?q=80&w=1200&auto=format&fit=crop"
            alt="Intro 1"
            height="600"
            width="1000"
          >
          <img
            class="carousel-img"
            src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop"
            alt="Intro 2"
            height="600"
            width="1000"
          >
          <img
            class="carousel-img"
            src="https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?q=80&w=1200&auto=format&fit=crop"
            alt="Intro 3"
            height="600"
            width="1000"
          >
          <img
            class="carousel-img"
            src="https://images.unsplash.com/photo-1551632811-561732d1e306?q=80&w=1200&auto=format&fit=crop"
            alt="Intro 4"
            height="600"
            width="1000"
          >
        {% endif %}
      </div>
    </div>
  </div>

  <div class="intro-scroll-space"></div>

  <div class="stage" id="stage">
    <div class="sticky">
      <!-- Layer 1 -->
      <section class="layer layer--over" id="layer1">
        <div class="image">
          {% if section.settings.layer1_image %}
            <img
              src="{{ section.settings.layer1_image | image_url: width: 2000 }}"
              alt="{{ section.settings.layer1_image.alt | escape | default: 'Layer 1 image' }}"
              width="2000"
              height="1200"
            >
          {% endif %}
          <img
            src="https://images.unsplash.com/photo-1479064555552-3ef4979f8908?q=80&w=1200&auto=format&fit=crop"
            alt="Vision Image"
            width="1200"
            height="800"
          >
        </div>

        <div class="text">
          <h1 class="letter-slide">
            {{ section.settings.layer1_title | default: 'VISION<sup>®</sup>' }}
          </h1>
          <p>
            {{
              section.settings.layer1_body
              | newline_to_br
              | default: "→ The world's most authentic, community-driven running brand..."
            }}
          </p>
        </div>

        <div class="infinity-wrapper">
          <svg viewBox="0 0 600 300" class="infinity-text">
            <!-- True infinity symbol path -->
            <path id="infinityPath"
                  d="M 150 150
                     C 150 50, 250 50, 300 150
                     C 350 50, 450 50, 450 150
                     C 450 250, 350 250, 300 150
                     C 250 250, 150 250, 150 150 Z"
                  fill="none"
                  stroke="transparent"
                  stroke-width="0"/>
            <text font-size="20" fill="#111" font-weight="bold">
              <textPath id="infinityMovingText" href="#infinityPath" startOffset="0%">
                {{ section.settings.layer1_infinity_text | default: "EVOLVE THE FULL EXPERIENCE OF RUNNING • EVOLVE THE FULL EXPERIENCE OF RUNNING  " }}
              </textPath>
            </text>
          </svg>
        </div>
      </section>

      <!-- Layer 2 -->
      <section class="layer layer--under" id="layer2">
        <div class="text">
          <h1>{{ section.settings.layer2_heading | default: 'VALUES' }}</h1>
          <hr>
          {% assign value_blocks = section.blocks | where: 'type', 'value_item' %}
          {% if value_blocks.size > 0 %}
            {% for vb in value_blocks %}
              {% if vb.settings.text != blank %}
                <p>{{ vb.settings.text }}</p>
                <hr>
              {% endif %}
            {% endfor %}
          {% else %}
            <p>TRUST</p>
            <hr>
            <p>EMPATHY</p>
            <hr>
            <p>EXCELLENCE</p>
            <hr>
          {% endif %}
          {% if section.settings.layer2_subheader != blank %}
            <p class="subheader">{{ section.settings.layer2_subheader }}</p>
          {% else %}
            <p class="subheader">THE STANDARD FOR OURSELVES INTERNALLY AND EXTERNALLY.</p>
          {% endif %}
        </div>
        <div class="image">
          {% if section.settings.layer2_image %}
            <img
              src="{{ section.settings.layer2_image | image_url: width: 2000 }}"
              alt="{{ section.settings.layer2_image.alt | escape | default: 'Values image' }}"
              width="2000"
              height="1200"
            >
          {% endif %}
          <img
            src="https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?q=80&w=1200&auto=format&fit=crop"
            alt="Values Image"
            width="1200"
            height="800"
          >
        </div>
      </section>

      <!-- Layer 3 -->
      <section class="layer layer--third" id="layer3" style="height:697px;">
        <div class="images">
          {% if section.settings.layer3_image %}
            <img
              src="{{ section.settings.layer3_image | image_url: width: 2000 }}"
              alt="{{ section.settings.layer3_image.alt | escape | default: 'Layer 3 image' }}"
              width="2000"
              height="1200"
            >
          {% endif %}
          <img
            src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop"
            alt="Collage 2"
            width="1200"
            height="800"
          >
        </div>
        <svg viewBox="0 0 450 500">
          <path id="rectPath"
                d="M 50 50
                   H 50
                   A 60 60 0 0 1 570 70
                   V 330
                   A 20 20 0 0 1 550 350
                   H 50
                   A 60 60 0 0 1 30 330
                   V 70
                   A 60 60 0 0 1 50 50 Z"
                fill="none" stroke="#333" stroke-width="0"/>
          <text dy="-5">
            <textPath id="movingText" href="#rectPath" startOffset="100%">
              {{ section.settings.layer3_svg_text | default: 'THE FULL EXPERIENCE OF RUNNING • THE FULL EXPERIENCE OF RUNNING •' }}
            </textPath>
          </text>
        </svg>
        <div class="text">
          <h1 id="layer3-heading">{{ section.settings.layer3_heading | default: 'IN OUR<br>DNA<sup>4</sup>' }}</h1>
        </div>
      </section>

      <!-- Layer 4 -->
      <section class="layer layer--fourth" id="layer4" style="margin-top:14vh;">
        <div class="content">
          <h2>{{ section.settings.layer4_heading | default: 'STORY<sup>5</sup>' }}</h2>
          <p>
            <span class="arrow">→</span>
            {{
              section.settings.layer4_body
              | newline_to_br
              | default: 'Bandit was founded by members of the NYC running community...'
            }}
          </p>
        </div>
      </section>
    </div>
  </div>
</section>

<style>
  .infinity-wrapper {
    position: fixed;
    top: 85%;
    left: 20%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 200px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .infinity-text {
    width: 100%;
    height: 100%;
  }

  .infinity-text text {
    letter-spacing: 2px;
    text-transform: uppercase;
    font-weight: bold;
    font-size: 24px;
    fill: #111;
  }
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  .intro {
    top: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    height: 100vh;
    padding: 2rem;
    z-index: 10;
    transition: opacity 0.3s ease;
  }

  .intro-content {
    grid-column: 1 / 2;
    grid-row: 1 / 2;
    align-self: start;
    justify-self: start;
  }

  .intro-content h1 {
    font-size: 7.5rem;
    margin-bottom: 1rem;
  }
  .intro-content p {
    font-size: 1.5rem;
  }

  .carousel {
    grid-column: 2 / 3;
    grid-row: 2 / 3;
    position: relative;
    width: 80%;
    height: 160%;
    align-self: end;
    justify-self: end;
    overflow: hidden;
    border-radius: 12px;
  }

  .carousel-track {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .carousel-img {
    position: absolute;
    left: 50%;
    width: 87%;
    height: 100%;
    object-fit: cover;
    transform: translate(-50%, 100%) scale(1);
    transition: transform 0.2s ease-out;
    border-radius: 12px;
  }
  .carousel-img:nth-child(1) {
    z-index: 1;
    transform: translate(-50%, 0%) scale(1);
  }
  .carousel-img:nth-child(2) {
    z-index: 2;
  }
  .carousel-img:nth-child(3) {
    z-index: 3;
  }
  .carousel-img:nth-child(4) {
    z-index: 3;
  }

  .intro-scroll-space {
    height: 300vh;
  }

  .stage {
    position: relative;
    height: 400vh;
  }
  .sticky {
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: hidden;
  }

  .layer {
    position: absolute;
    inset: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    padding: 5vh 5vw;
    --slide: 0px;
    transform: translateY(var(--slide));
  }
  #layer4 {
    padding: 0vh 0vw;
    display: block;
  }

  .layer h1 {
    font-size: 64px;
    margin-bottom: var(--space-lg);
  }
  .layer p {
    font-size: 24px;
    margin: var(--space-sm) 0;
  }

  .layer img {
    width: 100%;
    max-height: fit-content;
    margin-top: 0px;
    object-fit: cover;
    border-radius: 12px;
  }
  .layer--over {
    background: #d6d1bc;
    z-index: 4;
  }
  .layer--under {
    background: #ffffff;
    z-index: 3;
    margin-top: 10vh;
  }
  .layer--third {
    background: #ffffff;
    z-index: 2;
  }
  .layer--fourth {
    background: #ffffff;
    z-index: 1;
  }

  /* Layout for Layer 1 */
  #layer1 {
    width: 98%;
    margin-inline-start: var(--space-2xl);
    grid-template-columns: 1fr 1fr;
    align-items: stretch;
  }
  #layer1 .image {
    display: flex;
    overflow: hidden;
  }
  #layer1 .image img {
    width: 100%;
    height: auto;
  }
  #layer1 .text {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 0rem 2rem;
  }
  #layer1 h1 {
    font-size: 7.5rem;
    font-weight: 700;
    letter-spacing: -1px;
    margin-bottom: 16rem;
  }
  #layer1 p {
    font-size: 3.6rem;
    font-weight: 400;
  }

  /* Layer 2 */
  #layer2 {
    grid-template-columns: 1fr 1fr;
    align-items: stretch;
    min-height: 100vh;
    padding: 1rem;
  }
  #layer2 .text {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    font-weight: bold;
  }
  #layer2 .text h1 {
    font-size: 7.5rem;
    margin-bottom: 1rem;
  }
  #layer2 .text p {
    font-size: 2.6rem;
  }
  #layer2 .text .subheader {
    font-size: 1.3rem;
    font-weight: normal;
    margin-top: 1.25rem;
  }
  #layer2 hr {
    border: none;
    border-top: 1px solid #000;
  }
  #layer2 .image {
    margin-top: 30%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    margin-left: 1rem;
  }

  /* Layer 3 */
  #layer3 {
    background: #ffffff;
    color: #000000;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    padding: 6vh 5vw;
    position: relative;
  }
  #layer3 .images {
    display: flex;
    gap: 1rem;
    z-index: 1;
  }
  #layer3 svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: visible;
    z-index: 5;
    pointer-events: none;
  }
  #layer3 text {
    font-size: 10px;
    letter-spacing: 0px;
  }

  /* Layer 3 heading anim start state */
  #layer3 h1 {
    font-size: 6rem;
    font-weight: 700;
    line-height: 1;
    letter-spacing: -1px;
    transform-origin: center center;
    opacity: 0;
    transform: perspective(1200px) translateX(150vw) translateZ(-300px) rotateY(45deg) rotateX(15deg) scale(0.7);
    text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  /* Layer 4 */
  #layer4 {
    background: #7c8f82;
    color: #1a1a1a;
    padding: 6vh 0.5vw;
    font-family: 'Helvetica Neue', Arial, sans-serif;
  }
  #layer4 .content {
    border-top: 1px solid #1a1a1a;
  }
  #layer4 h2 {
    font-size: 7.5rem;
    font-weight: 700;
  }
  #layer4 p {
    font-size: 4.4rem;
  }
  #layer4 .arrow {
    font-size: 1.8rem;
    font-weight: bold;
    margin-right: 0.5rem;
  }

  .letter-slide {
    display: flex;
    font-size: 4rem;
    font-weight: bold;
  }
  .letter-slide span {
    display: inline-block;
    opacity: 0;
    transform: translateX(100vw);
    animation: slideInFromExtremeRight 0.3s forwards;
    animation-timing-function: ease-out;
  }
  @keyframes slideInFromExtremeRight {
    0% {
      opacity: 0;
      transform: translateX(100vw);
    }
    100% {
      opacity: 1;
      transform: translateX(0);
    }
  }
  .intro-subtext {
    display: inline-block;
    font-weight: 400;
    line-height: 1.4;
  }

  .intro-subtext span {
    display: inline-block;
    opacity: 0;
    transform: translateX(100vw);
    animation: slideInFromExtremeRight 0.3s forwards ease-out;
    will-change: transform;
  }

  @media (max-width: 768px) {
    #layer3 {
      margin-top: 20%;
    }
    .letter-slide,
    #layer2 .text h1,
    #layer3 h1,
    #layer2 h2 {
      font-size: 48px !important;
    }
    .layer img {
      max-height: 360px;
    }
    #layer1 p,
    #layer2 .text p,
    #layer4 p {
      font-size: 24px !important;
      line-height: 0.9;
    }
    #layer2 .text .subheader {
      font-size: 14px !important;
    }
    .intro {
      display: block !important;
    }
    .carousel {
      height: 70% !important;
      width: 100% !important;
    }
    #layer1,
    #layer2,
    #layer3 {
      display: block !important;
      width: 100% !important;
      margin-inline-start: 0 !important;
    }
    #layer2 .image {
      margin-top: 10% !important;
      margin-left: 0 !important;
    }
    .infinity-wrapper {
      left: 50% !important;
      top: 62% !important;
    }
    .carousel-img {
      left: 43% !important;
      width: 100% !important;
    }
  }
</style>

<script>
  function splitLetters(el) {
    if (!el) return;
    const txt = el.textContent.trim();
    el.innerHTML = txt
      .split('')
      .map((l, i) => `<span style="--i:${i}">${l}</span>`)
      .join('');
  }

  splitLetters(document.querySelector('.letter-slide'));
  splitLetters(document.querySelector('.intro-subtext'));

  const textPath = document.getElementById('movingText');
  window.addEventListener('scroll', () => {
    if (!textPath) return;
    const scrollPercent = window.scrollY / (document.body.scrollHeight - window.innerHeight);
    const offset = scrollPercent * 100;
    textPath.setAttribute('startOffset', offset + '%');
  });

  // Enhanced cuboidal animation for Layer 3 heading
  const heading3 = document.getElementById('layer3-heading');
  const layer3 = document.getElementById('layer3');

  function animateLayer3() {
    if (!heading3 || !layer3) {
      requestAnimationFrame(animateLayer3);
      return;
    }
    const rect = layer3.getBoundingClientRect();
    const vh = window.innerHeight;
    let progress = 1 - Math.max(0, Math.min(1, rect.top / vh));
    const eased = progress * progress * (3 - 2 * progress);

    if (progress > 0.1) {
      const opacity = Math.min(1, (progress - 0.1) / 0.3);
      const translateX = (1 - eased) * 150;
      const translateZ = (1 - eased) * -300;
      const rotateY = (1 - eased) * 45;
      const rotateX = (1 - eased) * 15;
      const scale = 0.7 + eased * 0.3;
      const shadowBlur = 30 * (1 - eased);
      const shadowOpacity = 0.3 * (1 - eased * 0.5);

      heading3.style.opacity = opacity;
      heading3.style.transform = `perspective(1200px) translateX(${translateX}vw) translateZ(${translateZ}px) rotateY(${rotateY}deg) rotateX(${rotateX}deg) scale(${scale})`;
      heading3.style.textShadow = `0 10px ${shadowBlur}px rgba(0,0,0,${shadowOpacity})`;
    } else {
      heading3.style.opacity = 0;
      heading3.style.transform =
        'perspective(1200px) translateX(150vw) translateZ(-300px) rotateY(45deg) rotateX(15deg) scale(0.7)';
    }

    requestAnimationFrame(animateLayer3);
  }
  requestAnimationFrame(animateLayer3);

  // Fix letter animation
  document.querySelectorAll('.letter-slide').forEach((title) => {
    const txt = title.textContent;
    const letters = txt.trim().split('');
    title.innerHTML = letters.map((l, i) => `<span style="animation-delay:${i * 0.1}s">${l}</span>`).join('');
  });

  const intro = document.getElementById('intro');
  const images = document.querySelectorAll('.carousel-img');
  const totalImages = images.length;

  function updateCarousel() {
    const rect = intro.getBoundingClientRect();
    const vh = window.innerHeight;

    const offsetStart = 0.2; // start slightly early
    const speedFactor = 2.5; // increase speed (>1 faster, <1 slower)

    let progress = (-rect.top / vh + offsetStart) * speedFactor;
    progress = Math.min(1, Math.max(0, progress));

    const segment = 1 / totalImages;

    images.forEach((img, i) => {
      if (i === 0) {
        // First image stays fixed
        img.style.transform = `translate(-50%, 0%) scale(1)`;
        img.style.opacity = 1;
        return;
      }

      const start = i * segment;
      const end = (i + 1) * segment;

      let localProgress = 0;
      if (progress < start) localProgress = 0;
      else if (progress > end) localProgress = 1;
      else localProgress = (progress - start) / segment;

      // interpolate y-position and scale
      const startY = 30; // initial offset %
      const endY = 0; // final position %
      const startScale = 1;
      const endScale = 1.05;

      const y = startY + (endY - startY) * localProgress;
      const scale = startScale + (endScale - startScale) * localProgress;
      const opacity = localProgress; // fade in

      img.style.transform = `translate(-50%, ${y}%) scale(${scale})`;
      img.style.opacity = opacity;
    });

    requestAnimationFrame(updateCarousel);
  }

  requestAnimationFrame(updateCarousel);

  // Stage parallax for layers 1-3
  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
  const stage = document.getElementById('stage');
  const vh = window.innerHeight;
  const l1 = document.getElementById('layer1');
  const l2 = document.getElementById('layer2');
  const l3 = document.getElementById('layer3');

  function frame() {
    const rect = stage.getBoundingClientRect();
    const total = stage.offsetHeight - vh;
    const p = total > 0 ? clamp(-rect.top / total, 0, 1) : 0;
    const seg = 1 / 3;
    const p1 = clamp(p / seg, 0, 1);
    l1.style.setProperty('--slide', `${-vh * p1}px`);
    const p2 = clamp((p - seg) / seg, 0, 1);
    l2.style.setProperty('--slide', `${-vh * p2}px`);
    const p3 = clamp((p - 2 * seg) / seg, 0, 1);
    l3.style.setProperty('--slide', `${-vh * p3}px`);
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  const infinityText = document.getElementById('infinityMovingText');
  let lastScrollY = window.scrollY;
  let offset = 0;

  function updateInfinityOnScroll() {
    if (!infinityText) return;

    const currentScrollY = window.scrollY;
    const delta = currentScrollY - lastScrollY; // positive when scrolling down
    lastScrollY = currentScrollY;

    // Adjust offset based on scroll direction and speed
    offset += delta * 0.3; // tweak 0.3 for speed
    offset %= 100; // loop at 100%

    infinityText.setAttribute('startOffset', offset + '%');

    requestAnimationFrame(updateInfinityOnScroll);
  }

  requestAnimationFrame(updateInfinityOnScroll);

  // Optional: auto-move when not scrolling
  let lastScrollTime = Date.now();

  function autoAnimateInfinity() {
    const now = Date.now();
    if (now - lastScrollTime > 2000) {
      // 2s no scroll
      offset += 0.2; // speed of auto-animation
      offset %= 100;
      infinityText.setAttribute('startOffset', offset + '%');
    }
    requestAnimationFrame(autoAnimateInfinity);
  }

  window.addEventListener('scroll', () => (lastScrollTime = Date.now()));
  autoAnimateInfinity();
</script>

{% schema %}
{
  "name": "slideshow",
  "settings": [
    { "type": "text", "id": "intro_title", "label": "Intro Title", "default": "MISSION" },
    {
      "type": "textarea",
      "id": "intro_subtext",
      "label": "Intro Subtext (use new lines)",
      "default": "EVOLVE\nTHE FULL\nEXPERIENCE OF RUNNING"
    },

    { "type": "image_picker", "id": "layer1_image", "label": "Layer 1 Image" },
    { "type": "text", "id": "layer1_title", "label": "Layer 1 Title (HTML allowed)", "default": "VISION<sup>®</sup>" },
    {
      "type": "textarea",
      "id": "layer1_body",
      "label": "Layer 1 Body",
      "default": "→ The world's most authentic, community-driven running brand..."
    },

    { "type": "image_picker", "id": "layer2_image", "label": "Layer 2 Image" },
    { "type": "text", "id": "layer2_heading", "label": "Layer 2 Heading", "default": "VALUES" },
    {
      "type": "text",
      "id": "layer2_subheader",
      "label": "Layer 2 Subheader",
      "default": "THE STANDARD FOR OURSELVES INTERNALLY AND EXTERNALLY."
    },

    { "type": "image_picker", "id": "layer3_image", "label": "Layer 3 Image" },
    {
      "type": "text",
      "id": "layer3_heading",
      "label": "Layer 3 Heading (HTML allowed)",
      "default": "IN OUR<br>DNA<sup>4</sup>"
    },
    {
      "type": "text",
      "id": "layer3_svg_text",
      "label": "Layer 3 SVG Moving Text",
      "default": "THE FULL EXPERIENCE OF RUNNING • THE FULL EXPERIENCE OF RUNNING •"
    },

    {
      "type": "text",
      "id": "layer4_heading",
      "label": "Layer 4 Heading (HTML allowed)",
      "default": "STORY<sup>5</sup>"
    },
    {
      "type": "textarea",
      "id": "layer4_body",
      "label": "Layer 4 Body",
      "default": "Bandit was founded by members of the NYC running community..."
    }
  ],
  "blocks": [
    {
      "type": "carousel_image",
      "name": "Carousel Image",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "alt", "label": "Alt text" }
      ]
    },
    {
      "type": "value_item",
      "name": "Value Item",
      "settings": [{ "type": "text", "id": "text", "label": "Value Text", "default": "TRUST" }]
    }
  ],
  "max_blocks": 20,
  "presets": [{ "name": "slideshow", "category": "Custom" }]
}
{% endschema %}
