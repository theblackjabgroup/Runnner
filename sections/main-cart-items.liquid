{{ 'main-cart-items.css' | asset_url | stylesheet_tag }}

<div class="cart-container">
  <div class="cart-header">
    <h2 class="cart-title">Cart [{{ cart.item_count }}]</h2>
  </div>

  <div class="cart-content">
    <div class="cart-items">
      {% if cart.item_count > 0 %}
        <form action="{{ routes.cart_url }}" method="post" id="MainCartForm">
          {% for item in cart.items %}
            <div class="cart-item">
              <img
                class="item-image-cart-page"
                src="{{ item.image | image_url: width: 400 }}"
                alt="{{ item.product.title | escape }}"
                height="222"
                width="186"
                loading="lazy"
                sizes="(max-width: 768px) 128px, 186px"
                srcset="
                  {{ item.image | image_url: width: 128 }} 128w,
                  {{ item.image | image_url: width: 186 }} 186w,
                  {{ item.image | image_url: width: 256 }} 256w,
                  {{ item.image | image_url: width: 372 }} 372w
                "
              >

              <div class="item-details">
                <div class="item-info">
                  <div class="item-price">
                    {% if item.original_price != item.final_price %}
                      {{ item.final_price | money }}
                    {% else %}
                      {{ item.original_price | money }}
                    {% endif %}
                  </div>
                  <div class="item-title-cart-page">{{ item.product.title }}</div>
                </div>

                <div class="item-options">
                  {% assign size_option = null %}
                  {% assign color_option = null %}

                  {% for option in item.options_with_values %}
                    {% assign option_name_lower = option.name | downcase %}
                    {% if option_name_lower contains 'size' %}
                      {% assign size_option = option %}
                    {% elsif option_name_lower contains 'color' or option_name_lower contains 'colour' %}
                      {% assign color_option = option %}
                    {% endif %}
                  {% endfor %}
                  {% if size_option %}
                    <div class="option-row">
                      <span class="option-label">{{ size_option.name }}:</span>
                      <span class="option-value selected">{{ size_option.value }}</span>
                    </div>
                  {% endif %}

                  {% if color_option %}
                    <div class="option-row">
                      <span class="option-label">{{ color_option.name }}:</span>
                      <div class="color-options">
                        {% assign current_color = color_option.value %}
                        {% assign color_class = current_color
                          | downcase
                          | replace: ' ', ''
                          | replace: '-', ''
                          | replace: '_', ''
                        %}

                        {% comment %} Show the current color swatch {% endcomment %}
                        {% comment %} Check if we have a CSS class for this color, otherwise use inline style {% endcomment %}
                        {% assign has_css_class_current = false %}
                        {% if color_class == 'black'
                          or color_class == 'white'
                          or color_class == 'red'
                          or color_class == 'blue'
                          or color_class == 'navy'
                          or color_class == 'nynavy'
                          or color_class == 'gray'
                          or color_class == 'grey'
                          or color_class == 'brown'
                          or color_class == 'green'
                          or color_class == 'yellow'
                          or color_class == 'orange'
                          or color_class == 'purple'
                          or color_class == 'pink'
                          or color_class == 'beige'
                        %}
                          {% assign has_css_class_current = true %}
                        {% endif %}

                        {% if has_css_class_current %}
                          <div
                            class="color-picker {{ color_class }} selected"
                            data-variant-id="{{ item.variant.id }}"
                            data-color="{{ current_color }}"
                            data-item-key="{{ item.key }}"
                            data-current-size="{{ size_option.value | default: '' }}"
                            title="{{ current_color }}"
                          ></div>
                        {% else %}
                          <div
                            class="color-picker selected"
                            data-variant-id="{{ item.variant.id }}"
                            data-color="{{ current_color }}"
                            data-item-key="{{ item.key }}"
                            data-current-size="{{ size_option.value | default: '' }}"
                            title="{{ current_color }}"
                            style="background: {{ current_color | downcase }} !important;"
                          ></div>
                        {% endif %}

                        {% comment %} Show other available colors if they exist {% endcomment %}
                        {% comment %} PERFORMANCE: Pre-calculate color option index (do once, not per variant) {% endcomment %}
                        {% assign color_option_index = null %}
                        {% for i in (0..2) %}
                          {% case i %}
                            {% when 0 %}
                              {% assign check_option = item.product.options[0] %}
                            {% when 1 %}
                              {% assign check_option = item.product.options[1] %}
                            {% when 2 %}
                              {% assign check_option = item.product.options[2] %}
                          {% endcase %}
                          {% if check_option and check_option != 'Title' and color_option_index == null %}
                            {% assign option_name_lower = check_option | downcase %}
                            {% if option_name_lower contains 'color' or option_name_lower contains 'colour' %}
                              {% assign color_option_index = i %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}

                        {% assign displayed_colors = current_color | append: ',' %}

                        {% comment %} PERFORMANCE: Optimized single loop (was O(nÂ³), now O(n)) {% endcomment %}
                        {% if color_option_index != null %}
                          {% for variant in item.product.variants %}
                            {% comment %} Get color based on pre-calculated index {% endcomment %}
                            {% assign variant_color = null %}
                            {% if color_option_index == 0 %}
                              {% assign variant_color = variant.option1 %}
                            {% elsif color_option_index == 1 %}
                              {% assign variant_color = variant.option2 %}
                            {% elsif color_option_index == 2 %}
                              {% assign variant_color = variant.option3 %}
                            {% endif %}

                            {% comment %} Only process if color is valid and new {% endcomment %}
                            {% if variant_color != blank
                              and variant_color != 'Default Title'
                              and variant_color != current_color
                            %}
                              {% unless displayed_colors contains variant_color %}
                                {% assign displayed_colors = displayed_colors | append: variant_color | append: ',' %}
                                {% assign color_class = variant_color
                                  | downcase
                                  | replace: ' ', ''
                                  | replace: '-', ''
                                  | replace: '_', ''
                                %}

                                {% comment %} Check if we have a CSS class for this color, otherwise use inline style {% endcomment %}
                                {% assign has_css_class = false %}
                                {% if color_class == 'black'
                                  or color_class == 'white'
                                  or color_class == 'red'
                                  or color_class == 'blue'
                                  or color_class == 'navy'
                                  or color_class == 'nynavy'
                                  or color_class == 'gray'
                                  or color_class == 'grey'
                                  or color_class == 'brown'
                                  or color_class == 'green'
                                  or color_class == 'yellow'
                                  or color_class == 'orange'
                                  or color_class == 'purple'
                                  or color_class == 'pink'
                                  or color_class == 'beige'
                                %}
                                  {% assign has_css_class = true %}
                                {% endif %}

                                {% if has_css_class %}
                                  <div
                                    class="color-picker {{ color_class }}"
                                    data-variant-id="{{ variant.id }}"
                                    data-color="{{ variant_color }}"
                                    data-item-key="{{ item.key }}"
                                    data-current-size="{{ size_option.value | default: '' }}"
                                    title="{{ variant_color }}"
                                  ></div>
                                {% else %}
                                  <div
                                    class="color-picker"
                                    data-variant-id="{{ variant.id }}"
                                    data-color="{{ variant_color }}"
                                    data-item-key="{{ item.key }}"
                                    data-current-size="{{ size_option.value | default: '' }}"
                                    title="{{ variant_color }}"
                                    style="background: {{ variant_color | downcase }} !important;"
                                  ></div>
                                {% endif %}
                              {% endunless %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}

                  {% for option in item.options_with_values %}
                    {% assign option_name_lower = option.name | downcase %}
                    {% unless option_name_lower contains 'size'
                      or option_name_lower contains 'color'
                      or option_name_lower contains 'colour'
                      or option_name_lower contains 'title'
                    %}
                      <div class="option-row">
                        <span class="option-label">{{ option.name }}:</span>
                        <span class="option-value selected">{{ option.value }}</span>
                      </div>
                    {% endunless %}
                  {% endfor %}

                  {%- comment -%} Mobile quantity controls (hidden on desktop) {%- endcomment -%}
                  <div
                    class="quantity-controls-mobile"
                    data-item-key="{{ item.key }}"
                    data-item-quantity="{{ item.quantity }}"
                  >
                    {% render 'quantity-input', item: item, variant: item.variant, mobile: true, for_cart: true %}
                  </div>
                </div>
              </div>

              <div class="item-controls">
                <div
                  class="quantity-controls-desktop"
                  data-item-key="{{ item.key }}"
                  data-item-quantity="{{ item.quantity }}"
                >
                  {% render 'quantity-input', item: item, variant: item.variant, mobile: false, for_cart: true %}
                </div>
                <button class="remove-btn" data-item-key="{{ item.key }}">[Remove]</button>
              </div>
            </div>
          {% endfor %}
        </form>
      {% else %}
        <div class="empty-cart-message">Your cart is sad :(</div>
      {% endif %}
    </div>

    <div class="cart-sidebar">
      <div class="sidebar-sections">
        <div class="sidebar-section">
          <div class="sidebar-header">
            <span class="sidebar-title"
              >Add a Note to<br>
              Your Order:</span
            >
            <span class="expand-icon"><span class="pmorph__icon"></span></span>
          </div>
          <div class="sidebar-content">
            <form class="sidebar-form note-form">
              <textarea class="sidebar-input" placeholder="Type..." rows="3"></textarea>
              <button type="submit" class="sidebar-btn">[SEND]</button>
            </form>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-header">
            <span class="sidebar-title"
              >Receive Special Offers and<br>
              First Look at New Products.</span
            >
            <span class="expand-icon"><span class="pmorph__icon"></span></span>
          </div>
          <div class="sidebar-content">
            <form class="sidebar-form">
              <input type="email" class="sidebar-input" placeholder="Your Email" required>
              <button type="submit" class="sidebar-btn subscribe-btn">
                <span>SUBSCRIBE</span>
                <span class="subscribe-icon" aria-hidden="true">
                  {% if settings.tertiary_button_custom_icon != blank %}
                    <img
                      src="{{ settings.tertiary_button_custom_icon | image_url: width: 20 }}"
                      alt="icon"
                      width="20"
                      height="20"
                      style="display: block;"
                    >
                  {% else %}
                    <svg
                      width="20"
                      height="20"
                      viewBox="4.5 1.5 8.5 13"
                      fill="currentColor"
                      xmlns="http://www.w3.org/2000/svg"
                      stroke="currentColor"
                    >
                      <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
                    </svg>
                  {% endif %}
                </span>
              </button>
            </form>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-header">
            <span class="sidebar-title">Estimate Shipping Rates</span>
            <span class="expand-icon"><span class="pmorph__icon"></span></span>
          </div>
          <div class="sidebar-content">
            <form class="sidebar-form shipping-estimate-form" id="shipping-estimate-form">
              <input type="text" class="sidebar-input" placeholder="Zip Code" id="shipping-zip" required>
              <button type="submit" class="sidebar-btn">[SEARCH]</button>
            </form>
            <div class="shipping-results" id="shipping-results" style="display: none;">
              <div class="shipping-loading" id="shipping-loading" style="display: none;">
                <span>Calculating rates...</span>
              </div>
              <div class="shipping-options" id="shipping-options"></div>
              <div class="shipping-error" id="shipping-error" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="cart-total-section">
        <div class="cart-total">
          <span class="total-label">Total:</span>
          <span class="total-amount">
            {{ cart.total_price | money }}
          </span>
        </div>
        {%- if cart == empty -%}
          {%- assign checkout_wrapper_class = 'checkout-btn-wrapper cart-empty' -%}
        {%- else -%}
          {%- assign checkout_wrapper_class = 'checkout-btn-wrapper' -%}
        {%- endif -%}

        <div class="{{ checkout_wrapper_class }}">
          {% render 'tertiary-button',
            button_text: 'CHECKOUT',
            button_font_size: 'var(--t-b-1-size)',
            font_weight: 'var(--t-b-1-weight)',
            button_line_height: 'var(--t-b-1-line-height)',
            mobile_font_size: 'var(--tm-b-2-size)',
            mobile_font_weight: 'var(--tm-b-2-weight)',
            mobile_line_height: 'var(--tm-b-2-line-height)',
            tertiary_class: 'add-to-cart-tertiary-btn cart-page-checkout-btn',
            button_type: 'button',
            button_width: '500px',
            button_height: '50px',
            mobile_button_width: '50vw',
            data_attributes: 'aria-describedby="add-to-cart-description"'
          %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ 'main-cart-items.js' | asset_url }}" defer="defer"></script>
