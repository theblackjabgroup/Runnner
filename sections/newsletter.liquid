{{ 'component-newsletter.css' | asset_url | stylesheet_tag }}

<div class="email-signup-section {% if section.settings.color_scheme != blank %}color-{{ section.settings.color_scheme }}{% endif %}" style="background-color: {{ section.settings.background_color }}; color: {{ section.settings.text_color }};">
  <form id="email-signup-form" class="email-signup-container">
    <input type="hidden" name="form_type" value="customer" />
    <input type="hidden" name="utf8" value="✓" />
    <input type="hidden" name="contact[tags]" value="newsletter" />
    
    <div class="message-container" style="display: none;"></div>
    
    <div class="form-fields-container">
      {% for block in section.blocks %}
        {% case block.type %}
          {% when 'email_input' %}
            <input type="email" name="contact[email]" class="email-input" placeholder="{{ block.settings.email_placeholder }}" required {{ block.shopify_attributes }}>
          {% when 'signup_button' %}
            <button type="submit" class="signup-button" style="background-color: {{ section.settings.button_color }}; color: {{ section.settings.button_text_color }};" {{ block.shopify_attributes }}>
              <span class="arrow-icon">→</span>
              <span>{{ block.settings.button_text }}</span>
            </button>
        {% endcase %}
      {% endfor %}
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const emailSignupForm = document.getElementById('email-signup-form');
    const emailInput = document.querySelector('.email-input');
    const signupButton = document.querySelector('.signup-button');
    const messageContainer = document.querySelector('.message-container');
    const formFieldsContainer = document.querySelector('.form-fields-container');
    
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    
    function showMessage(message, isError = false) {
      messageContainer.textContent = message;
      messageContainer.classList.remove('success-message', 'error-message');
      messageContainer.classList.add(isError ? 'error-message' : 'success-message');
      messageContainer.style.display = 'block';
    }
    
    emailSignupForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = emailInput.value.trim();
      
      if (!email) {
        showMessage('Please enter your email address', true);
        return;
      }
      
      if (!validateEmail(email)) {
        showMessage('Please enter a valid email address', true);
        return;
      }
      
      // Disable button during submission
      signupButton.disabled = true;
      signupButton.classList.add('loading');
      
      const formData = new FormData(emailSignupForm);
      
      // Use fetch API to submit the form without page navigation
      fetch('/contact#contact_form', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        // Handle successful submission
        emailInput.value = '';
        
        // Hide the form fields and show success message
        formFieldsContainer.style.display = 'none';
        showMessage('{{ section.settings.success_message | default: "Thank you for subscribing!" }}');
        
        // Optional: Show form again after some time
        if ({{ section.settings.show_form_again_after_success | default: true }}) {
          setTimeout(() => {
            formFieldsContainer.style.display = 'flex';
            messageContainer.style.display = 'none';
          }, {{ section.settings.form_reappear_time | default: 5000 }});
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('There was an error submitting your email. Please try again.', true);
      })
      .finally(() => {
        signupButton.disabled = false;
        signupButton.classList.remove('loading');
      });
    });
  });
</script>

{% schema %}
{
  "name": "Email Signup",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "default": "scheme-1",
      "label": "Color Scheme"
    }
  ],
  "blocks": [
    {
      "name": "Email Input",
      "type": "email_input",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "email_placeholder",
          "label": "Email Placeholder",
          "default": "EMAIL"
        }
      ]
    },
    {
      "name": "Signup Button",
      "type": "signup_button",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "SIGN ME UP"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Email Signup",
      "blocks": [
        {
          "type": "email_input"
        },
        {
          "type": "signup_button"
        }
      ]
    }
  ]
}
{% endschema %}
