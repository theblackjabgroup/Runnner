<style>
  .prod-diff-section {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100vw;
    overflow: hidden;
    background-color: rgb(242, 242, 242);
  }

  .prod-diff-container {
    position: relative;
    width: 100vw;
  }

  .prod-diff-wrapper {
    position: absolute;
    top: 0;
    overflow: hidden;
  }

  .prod-diff-wrapper.prod-diff-left {
    left: 0;
    width: 50%;
    display: block;
    unicode-bidi: isolate;
  }

  .prod-diff-wrapper.prod-diff-right {
    right: 0;
    width: 50%;
    display: block;
    unicode-bidi: isolate;
  }

  .prod-diff-img {
    position: absolute;
    left: 0;
    width: 100vw;
    height: auto;
    object-fit: cover;
    max-width: none;
    display: block;
  }

  .prod-diff-slider-container {
    position: absolute;
    width: 100%;
    top: 0;
    /* z-index: 10; */
  }

  .prod-diff-slider-divider {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 4px;
    left: 50%;
    transform: translateX(-50%);
    /* z-index: 15; */
    opacity: 1;
  }

  .prod-diff-slider-handle {
    position: absolute;
    height: 50px;
    width: 92px;
    background-color: black;
    border: 2px solid white;
    border-radius: 25px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    cursor: grab;
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    /* z-index: 10; */
    opacity: 1;
    pointer-events: auto;
    padding: 0 7px;
  }

  .prod-diff-slider-handle svg {
    width: 27px;
    height: 27px;
    fill: white;
  }

  .prod-diff-slider-handle-chevron {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    cursor: grab;
    opacity: 1;
    pointer-events: auto;
  }

  .prod-diff-wrapper.prod-diff-left .prod-diff-img {
    left: 0;
  }

  /* This will be dynamically set by JavaScript using percentages */
  .prod-diff-wrapper.prod-diff-right .prod-diff-img {
    left: -50%;
  }

  .prod-diff-product-info {
    position: absolute;
    bottom: 20px;
    padding: 10px 15px;
    max-width: 300px;
    width: auto;
  }

  .prod-diff-product-info.left {
    left: 20px;
    text-align: left;
  }

  .prod-diff-product-info.right {
    right: 20px;
    text-align: right;
  }

  .prod-diff-product-name {
    font-family: var(--font-body-family);
    font-style: var(--font-body-style);
    font-weight: var(--font-body-weight);
    font-size: 20px;
    color: var(--text);
    margin: 0 0 6px 0;
    line-height: 1.3;
  }

  .prod-diff-product-price {
    font-family: var(--font-body-family);
    font-style: var(--font-body-style);
    font-weight: var(--font-body-weight);
    font-size: 20px;
    color: var(--text);
    margin: 0;
  }

  @media (max-width: 768px) {
    .prod-diff-product-info {
      padding: 8px 12px;
      bottom: 15px;
      max-width: 200px;
    }

    .prod-diff-product-info.left {
      left: 10px;
      bottom: 0vw;
    }

    .prod-diff-product-info.right {
      right: 10px;
      bottom: 0vw;
    }

    .prod-diff-product-name {
      font-size: 16px;
    }

    .prod-diff-product-price {
      font-size: 16px;
    }
  }
</style>

{% if section.settings.enabled %}
  {% if section.settings.color_scheme %}
    {% assign section_classes_fc = section_classes_fc | append: ' color-' | append: section.settings.color_scheme %}
  {% endif %}
  {% comment %} Calculate the maximum height from both product images {% endcomment %}
  {% assign left_product = all_products[section.settings.left_product] %}
  {% assign right_product = all_products[section.settings.right_product] %}

  {% assign max_aspect_ratio = 0 %}

  {% if left_product and left_product.featured_image %}
    {% assign left_aspect_ratio = left_product.featured_image.aspect_ratio %}
    {% if left_aspect_ratio < max_aspect_ratio or max_aspect_ratio == 0 %}
      {% assign max_aspect_ratio = left_aspect_ratio %}
    {% endif %}
  {% endif %}

  {% if right_product and right_product.featured_image %}
    {% assign right_aspect_ratio = right_product.featured_image.aspect_ratio %}
    {% if right_aspect_ratio < max_aspect_ratio or max_aspect_ratio == 0 %}
      {% assign max_aspect_ratio = right_aspect_ratio %}
    {% endif %}
  {% endif %}

  {% comment %} Convert aspect ratio to CSS calc for responsive height {% endcomment %}
  {% if max_aspect_ratio > 0 %}
    {% assign height_vw = 100.0 | divided_by: max_aspect_ratio %}
  {% else %}
    {% assign height_vw = 50 %}
  {% endif %}

  <section class="prod-diff-section" style="height: {{ height_vw }}vw;">
    <div class="prod-diff-container" style="height: {{ height_vw }}vw;">
      <div class="prod-diff-wrapper prod-diff-left" style="height: {{ height_vw }}vw;">
        {% if left_product and left_product.featured_image %}
          <img
            srcset="
              {% if left_product.featured_image.width >= 375 %}{{ left_product.featured_image | image_url: width: 375 }} 375w,{% endif %}
              {% if left_product.featured_image.width >= 550 %}{{ left_product.featured_image | image_url: width: 550 }} 550w,{% endif %}
              {% if left_product.featured_image.width >= 750 %}{{ left_product.featured_image | image_url: width: 750 }} 750w,{% endif %}
              {% if left_product.featured_image.width >= 1100 %}{{ left_product.featured_image | image_url: width: 1100 }} 1100w,{% endif %}
              {% if left_product.featured_image.width >= 1500 %}{{ left_product.featured_image | image_url: width: 1500 }} 1500w,{% endif %}
              {% if left_product.featured_image.width >= 2200 %}{{ left_product.featured_image | image_url: width: 2200 }} 2200w,{% endif %}
              {{ left_product.featured_image | image_url }} {{ left_product.featured_image.width }}w
            "
            src="{{ left_product.featured_image | image_url: width: 1200 }}"
            alt="{{ left_product.title | escape }}"
            class="prod-diff-img"
            width="600"
            height="auto"
            style="height: auto; width: 100vw;"
          >
        {% else %}
          <div style="width: 500px; height: 100%;">
            {{ 'collection-1' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </div>

      <div class="prod-diff-wrapper prod-diff-right" style="height: {{ height_vw }}vw;">
        {% if right_product and right_product.featured_image %}
          <img
            srcset="
              {% if right_product.featured_image.width >= 375 %}{{ right_product.featured_image | image_url: width: 375 }} 375w,{% endif %}
              {% if right_product.featured_image.width >= 550 %}{{ right_product.featured_image | image_url: width: 550 }} 550w,{% endif %}
              {% if right_product.featured_image.width >= 750 %}{{ right_product.featured_image | image_url: width: 750 }} 750w,{% endif %}
              {% if right_product.featured_image.width >= 1100 %}{{ right_product.featured_image | image_url: width: 1100 }} 1100w,{% endif %}
              {% if right_product.featured_image.width >= 1500 %}{{ right_product.featured_image | image_url: width: 1500 }} 1500w,{% endif %}
              {% if right_product.featured_image.width >= 2200 %}{{ right_product.featured_image | image_url: width: 2200 }} 2200w,{% endif %}
              {{ right_product.featured_image | image_url }} {{ right_product.featured_image.width }}w
            "
            src="{{ right_product.featured_image | image_url: width: 1200 }}"
            alt="{{ right_product.title | escape }}"
            class="prod-diff-img"
            width="600"
            height="auto"
            style="height: auto; width: 100vw;"
          >
        {% else %}
          <div style="width: 500px; height: 100%;">
            {{ 'collection-1' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </div>

      <div class="prod-diff-slider-container" style="height: {{ height_vw }}vw;">
        <div class="prod-diff-slider-divider">
          {% comment %}
            <div class="prod-diff-slider-handle">
              <svg width="25" height="31" viewBox="0 0 25 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.4727 1.85254L1.62745 15.6977M1.62745 15.6977L15.4727 29.543M1.62745 15.6977L24.4498 15.6977" stroke="white" stroke-width="3" stroke-linejoin="round"/>
              </svg>

              <svg width="25" height="31" viewBox="0 0 25 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9.58594 1.85254L23.4311 15.6977M23.4311 15.6977L9.58594 29.543M23.4311 15.6977L0.608765 15.6977" stroke="white" stroke-width="3" stroke-linejoin="round"/>
              </svg>
            </div>
          {% endcomment %}
          <div class="prod-diff-slider-handle-chevron">
            <svg width="93" height="53" viewBox="0 0 93 53" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5.49805 51.1082H87.9111C90.1201 51.108 91.9111 49.3172 91.9111 47.1082V5.45001C91.9111 3.24102 90.1201 1.45026 87.9111 1.45001H5.49805C3.28891 1.45001 1.49805 3.24087 1.49805 5.45001V47.1082C1.49805 49.3174 3.28891 51.1082 5.49805 51.1082Z" fill="var(--button)" stroke="var(--button_label)" stroke-width="2"/>
              <path d="M73.4645 27.3039L61.7992 38.667C61.6908 38.7726 61.5621 38.8563 61.4205 38.9135C61.2789 38.9706 61.1271 39 60.9738 39C60.8205 39 60.6688 38.9706 60.5272 38.9135C60.3856 38.8563 60.2569 38.7726 60.1485 38.667C60.0401 38.5614 59.9541 38.4361 59.8955 38.2981C59.8368 38.1602 59.8066 38.0124 59.8066 37.8631C59.8066 37.7138 59.8368 37.5659 59.8955 37.428C59.9541 37.29 60.0401 37.1647 60.1485 37.0591L70.99 26.5L60.1485 15.9409C59.9296 15.7277 59.8066 15.4385 59.8066 15.1369C59.8066 14.8354 59.9296 14.5462 60.1485 14.333C60.3674 14.1198 60.6643 14 60.9738 14C61.2834 14 61.5803 14.1198 61.7992 14.333L73.4645 25.6961C73.573 25.8016 73.659 25.9269 73.7177 26.0649C73.7764 26.2028 73.8066 26.3507 73.8066 26.5C73.8066 26.6493 73.7764 26.7972 73.7177 26.9351C73.659 27.0731 73.573 27.1984 73.4645 27.3039Z" fill="var(--button_label)"/>
              <path d="M18.1488 27.3039L29.8141 38.667C29.9225 38.7726 30.0512 38.8563 30.1928 38.9135C30.3344 38.9706 30.4862 39 30.6395 39C30.7927 39 30.9445 38.9706 31.0861 38.9135C31.2277 38.8563 31.3564 38.7726 31.4648 38.667C31.5732 38.5614 31.6591 38.4361 31.7178 38.2981C31.7765 38.1602 31.8066 38.0124 31.8066 37.8631C31.8066 37.7138 31.7765 37.5659 31.7178 37.428C31.6591 37.29 31.5732 37.1647 31.4648 37.0591L20.6233 26.5L31.4648 15.9409C31.6837 15.7277 31.8066 15.4385 31.8066 15.1369C31.8066 14.8354 31.6837 14.5462 31.4648 14.333C31.2459 14.1198 30.949 14 30.6395 14C30.3299 14 30.033 14.1198 29.8141 14.333L18.1488 25.6961C18.0403 25.8016 17.9543 25.9269 17.8956 26.0649C17.8369 26.2028 17.8066 26.3507 17.8066 26.5C17.8066 26.6493 17.8369 26.7972 17.8956 26.9351C17.9543 27.0731 18.0403 27.1984 18.1488 27.3039Z" fill="var(--button_label)"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Product Information Divs -->
      {% if left_product %}
        <div class="prod-diff-product-info left">
          <h3 class="prod-diff-product-name">{{ left_product.title }}</h3>
          <p class="prod-diff-product-price">{{ left_product.price | money }}</p>
        </div>
      {% endif %}

      {% if right_product %}
        <div class="prod-diff-product-info right">
          <h3 class="prod-diff-product-name">{{ right_product.title }}</h3>
          <p class="prod-diff-product-price">{{ right_product.price | money }}</p>
        </div>
      {% endif %}
    </div>
  </section>
{% endif %}

<script>
  function initProductDifferenceSlider() {
    const sliderDivider = document.querySelector('.prod-diff-slider-divider');
    const sliderHandle = document.querySelector('.prod-diff-slider-handle-chevron');
    const container = document.querySelector('.prod-diff-container');

    // Return early if elements don't exist
    if (!sliderDivider || !sliderHandle || !container) return;

    let isDragging = false;
    const leftContainer = document.querySelector('.prod-diff-wrapper.prod-diff-left');
    const rightContainer = document.querySelector('.prod-diff-wrapper.prod-diff-right');
    const rightImg = document.querySelector('.prod-diff-wrapper.prod-diff-right .prod-diff-img');

    function getOffsetX(e) {
      if (e.touches) {
        return e.touches[0].clientX;
      } else {
        return e.clientX;
      }
    }

    function updateImagePositions() {
      if (!rightImg || !leftContainer) return;
      const containerWidth = container.offsetWidth;
      const leftWidth = leftContainer.offsetWidth;
      const rightImgLeftPosition = -leftWidth;
      rightImg.style.left = rightImgLeftPosition + 'px';
    }

    function onDrag(e) {
      if (!isDragging) return;
      if (e.cancelable) e.preventDefault();
      const rect = container.getBoundingClientRect();
      let x = getOffsetX(e) - rect.left;
      x = Math.max(0, Math.min(x, rect.width));
      const percent = (x / rect.width) * 100;
      sliderDivider.style.left = percent + '%';
      leftContainer.style.width = percent + '%';
      rightContainer.style.width = 100 - percent + '%';
      updateImagePositions();
    }

    function stopDrag() {
      isDragging = false;
      container.removeEventListener('mousemove', onDrag);
      container.removeEventListener('touchmove', onDrag);
      window.removeEventListener('mouseup', stopDrag);
      window.removeEventListener('touchend', stopDrag);
      window.removeEventListener('touchcancel', stopDrag);
    }

    // Allow dragging from both divider and handle
    [sliderDivider, sliderHandle].forEach(function (el) {
      el.addEventListener('mousedown', function (e) {
        e.preventDefault();
        isDragging = true;
        onDrag(e); // update position immediately
        container.addEventListener('mousemove', onDrag);
        window.addEventListener('mouseup', stopDrag);
      });
      el.addEventListener('touchstart', function (e) {
        isDragging = true;
        onDrag(e); // update position immediately
        container.addEventListener('touchmove', onDrag, { passive: false });
        window.addEventListener('touchend', stopDrag);
        window.addEventListener('touchcancel', stopDrag);
      });
    });

    // Handle window resize to update positions
    window.addEventListener('resize', function () {
      updateImagePositions();
    });

    // Initialize positions
    updateImagePositions();
  }

  // Make function globally available for theme editor
  window.initProductDifferenceSlider = initProductDifferenceSlider;

  document.addEventListener('DOMContentLoaded', function () {
    initProductDifferenceSlider();
  });

  // Theme Editor Event Handlers for proper reloading when products change
  if (typeof Shopify !== 'undefined' && Shopify.designMode) {
    document.addEventListener('shopify:section:load', function (event) {
      if (event.target.querySelector('.prod-diff-section')) {
        // Small delay to ensure DOM is fully updated
        setTimeout(function () {
          initProductDifferenceSlider();
        }, 10);
      }
    });

    document.addEventListener('shopify:section:select', function (event) {
      if (event.target.querySelector('.prod-diff-section')) {
        setTimeout(function () {
          initProductDifferenceSlider();
        }, 10);
      }
    });

    document.addEventListener('shopify:block:select', function (event) {
      const productDiffSection = event.target.closest('.shopify-section')?.querySelector('.prod-diff-section');
      if (productDiffSection) {
        setTimeout(function () {
          initProductDifferenceSlider();
        }, 10);
      }
    });

    // Listen for setting changes that might affect product selection
    document.addEventListener('shopify:section:reorder', function (event) {
      const productDiffSection = document.querySelector('.prod-diff-section');
      if (productDiffSection) {
        setTimeout(function () {
          initProductDifferenceSlider();
        }, 10);
      }
    });
  }
</script>

{% schema %}
{
  "name": "Product Difference Slider",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable section",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "product",
      "id": "left_product",
      "label": "Left Product"
    },
    {
      "type": "product",
      "id": "right_product",
      "label": "Right Product"
    }
  ],
  "presets": [
    {
      "name": "Product Difference Slider"
    }
  ]
}
{% endschema %}
