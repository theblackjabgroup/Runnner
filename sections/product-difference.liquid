<style>
  .prod-diff-section {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100vw;
    overflow: hidden;
  }

  .prod-diff-container {
    position: relative;
    width: 70vw;
  }

  .prod-diff-wrapper {
    position: absolute;
    top: 0;
    overflow: hidden;
  }

  .prod-diff-wrapper.prod-diff-left {
    left: 0;
    width: 50%;
    display: block;
    unicode-bidi: isolate;
  }

  .prod-diff-wrapper.prod-diff-right {
    right: 0;
    width: 50%;
    display: block;
    unicode-bidi: isolate;
  }

  .prod-diff-img {
    position: absolute;
    left: 0;
    width: 70vw;
    height: auto;
    object-fit: cover;
    max-width: none;
    display: block;
  }

  .prod-diff-slider-container {
    position: absolute;
    width: 100%;
    top: 0;
    z-index: 10;
  }

  .prod-diff-slider-divider {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 4px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 15;
    opacity: 1;
  }

  .prod-diff-slider-handle {
    position: absolute;
    height: 50px;
    width: 92px;
    background-color: black;
    border: 2px solid white;
    border-radius: 25px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    cursor: grab;
    display: flex !important;
    justify-content: center;
    align-items: center;
    z-index: 10;
    opacity: 1;
    pointer-events: auto;
  }

  .prod-diff-slider-handle::before,
  .prod-diff-slider-handle::after {
    content: '';
    position: absolute;
    height: 15px;
    width: 3px;
    background-color: white;
    border-radius: 1px;
  }

  .prod-diff-slider-handle::before {
    transform: translateX(-4px);
  }

  .prod-diff-slider-handle::after {
    transform: translateX(4px);
  }

  .prod-diff-wrapper.prod-diff-left .prod-diff-img {
    left: 0;
  }

  /* This will be dynamically set by JavaScript */
  .prod-diff-wrapper.prod-diff-right .prod-diff-img {
    left: -35vw;
  }
</style>

{% if section.settings.enabled %}
  {% if section.settings.color_scheme %}
    {% assign section_classes_fc = section_classes_fc | append: ' color-' | append: section.settings.color_scheme %}
  {% endif %}

  {% comment %} Calculate the maximum height from both product images {% endcomment %}
  {% assign left_product = all_products[section.settings.left_product] %}
  {% assign right_product = all_products[section.settings.right_product] %}

  {% assign max_aspect_ratio = 0 %}

  {% if left_product and left_product.featured_image %}
    {% assign left_aspect_ratio = left_product.featured_image.aspect_ratio %}
    {% if left_aspect_ratio < max_aspect_ratio or max_aspect_ratio == 0 %}
      {% assign max_aspect_ratio = left_aspect_ratio %}
    {% endif %}
  {% endif %}

  {% if right_product and right_product.featured_image %}
    {% assign right_aspect_ratio = right_product.featured_image.aspect_ratio %}
    {% if right_aspect_ratio < max_aspect_ratio or max_aspect_ratio == 0 %}
      {% assign max_aspect_ratio = right_aspect_ratio %}
    {% endif %}
  {% endif %}

  {% comment %} Convert aspect ratio to CSS calc for responsive height {% endcomment %}
  {% if max_aspect_ratio > 0 %}
    {% assign height_vw = 70.0 | divided_by: max_aspect_ratio %}
  {% else %}
    {% assign height_vw = 50 %}
  {% endif %}

  <section class="prod-diff-section" style="height: {{ height_vw }}vw;">
    <div class="prod-diff-container" style="height: {{ height_vw }}vw;">
      <div class="prod-diff-wrapper prod-diff-left" style="height: {{ height_vw }}vw;">
        {% if left_product and left_product.featured_image %}
          <img
            srcset="
              {% if left_product.featured_image.width >= 375 %}{{ left_product.featured_image | image_url: width: 375 }} 375w,{% endif %}
              {% if left_product.featured_image.width >= 550 %}{{ left_product.featured_image | image_url: width: 550 }} 550w,{% endif %}
              {% if left_product.featured_image.width >= 750 %}{{ left_product.featured_image | image_url: width: 750 }} 750w,{% endif %}
              {% if left_product.featured_image.width >= 1100 %}{{ left_product.featured_image | image_url: width: 1100 }} 1100w,{% endif %}
              {% if left_product.featured_image.width >= 1500 %}{{ left_product.featured_image | image_url: width: 1500 }} 1500w,{% endif %}
              {% if left_product.featured_image.width >= 2200 %}{{ left_product.featured_image | image_url: width: 2200 }} 2200w,{% endif %}
              {{ left_product.featured_image | image_url }} {{ left_product.featured_image.width }}w
            "
            src="{{ left_product.featured_image | image_url: width: 1200 }}"
            alt="{{ left_product.title | escape }}"
            class="prod-diff-img"
            width="600"
            height="auto"
            style="height: auto; width: 70vw;"
          >
        {% else %}
          <div style="width: 500px; height: 100%;">
            {{ 'collection-1' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </div>

      <div class="prod-diff-wrapper prod-diff-right" style="height: {{ height_vw }}vw;">
        {% if right_product and right_product.featured_image %}
          <img
            srcset="
              {% if right_product.featured_image.width >= 375 %}{{ right_product.featured_image | image_url: width: 375 }} 375w,{% endif %}
              {% if right_product.featured_image.width >= 550 %}{{ right_product.featured_image | image_url: width: 550 }} 550w,{% endif %}
              {% if right_product.featured_image.width >= 750 %}{{ right_product.featured_image | image_url: width: 750 }} 750w,{% endif %}
              {% if right_product.featured_image.width >= 1100 %}{{ right_product.featured_image | image_url: width: 1100 }} 1100w,{% endif %}
              {% if right_product.featured_image.width >= 1500 %}{{ right_product.featured_image | image_url: width: 1500 }} 1500w,{% endif %}
              {% if right_product.featured_image.width >= 2200 %}{{ right_product.featured_image | image_url: width: 2200 }} 2200w,{% endif %}
              {{ right_product.featured_image | image_url }} {{ right_product.featured_image.width }}w
            "
            src="{{ right_product.featured_image | image_url: width: 1200 }}"
            alt="{{ right_product.title | escape }}"
            class="prod-diff-img"
            width="600"
            height="auto"
            style="height: auto; width: 70vw;"
          >
        {% else %}
          <div style="width: 500px; height: 100%;">
            {{ 'collection-1' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </div>

      <div class="prod-diff-slider-container" style="height: {{ height_vw }}vw;">
        <div class="prod-diff-slider-divider">
          <div class="prod-diff-slider-handle"></div>
        </div>
      </div>
    </div>
  </section>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sliderDivider = document.querySelector('.prod-diff-slider-divider');
    const sliderHandle = document.querySelector('.prod-diff-slider-handle');
    const container = document.querySelector('.prod-diff-container');
    let isDragging = false;
    const leftContainer = document.querySelector('.prod-diff-wrapper.prod-diff-left');
    const rightContainer = document.querySelector('.prod-diff-wrapper.prod-diff-right');
    const rightImg = document.querySelector('.prod-diff-wrapper.prod-diff-right .prod-diff-img');

    function getOffsetX(e) {
      if (e.touches) {
        return e.touches[0].clientX;
      } else {
        return e.clientX;
      }
    }

    function onDrag(e) {
      if (!isDragging) return;
      if (e.cancelable) e.preventDefault();
      const rect = container.getBoundingClientRect();
      let x = getOffsetX(e) - rect.left;
      x = Math.max(0, Math.min(x, rect.width));
      const percent = (x / rect.width) * 100;
      sliderDivider.style.left = percent + '%';
      leftContainer.style.width = percent + '%';
      rightContainer.style.width = 100 - percent + '%';
      rightImg.style.left = `-${leftContainer.offsetWidth}px`;
    }

    function stopDrag() {
      isDragging = false;
      container.removeEventListener('mousemove', onDrag);
      container.removeEventListener('touchmove', onDrag);
      window.removeEventListener('mouseup', stopDrag);
      window.removeEventListener('touchend', stopDrag);
      window.removeEventListener('touchcancel', stopDrag);
    }

    // Allow dragging from both divider and handle
    [sliderDivider, sliderHandle].forEach(function (el) {
      el.addEventListener('mousedown', function (e) {
        e.preventDefault();
        isDragging = true;
        onDrag(e); // update position immediately
        container.addEventListener('mousemove', onDrag);
        window.addEventListener('mouseup', stopDrag);
      });
      el.addEventListener('touchstart', function (e) {
        isDragging = true;
        onDrag(e); // update position immediately
        container.addEventListener('touchmove', onDrag, { passive: false });
        window.addEventListener('touchend', stopDrag);
        window.addEventListener('touchcancel', stopDrag);
      });
    });
  });
</script>

{% schema %}
{
  "name": "Product Difference Slider",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable section",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "product",
      "id": "left_product",
      "label": "Left Product"
    },
    {
      "type": "product",
      "id": "right_product",
      "label": "Right Product"
    }
  ],
  "presets": [
    {
      "name": "Product Difference Slider"
    }
  ]
}
{% endschema %}
