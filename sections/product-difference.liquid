<style>
    /* --- COMMENT: The main 'section' element now handles padding --- */
    .prod-diff-section {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      overflow: hidden;
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
      max-height: 80vh; /* Maximum height constraint for both desktop and mobile */
    }

    @media screen and (min-width: 750px) {
      .prod-diff-section {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }

    /* --- COMMENT: The slider is now a single container using layered images instead of two sliding divs --- */
    .prod-diff-container {
      position: relative;
      width: 100%; /* Changed from 100vw to be contained by the parent's padding */
      overflow: hidden;
      cursor: col-resize;
      margin-top: {{ section.settings.margin_top }}px;
      margin-bottom: {{ section.settings.margin_bottom }}px;
      max-height: 80vh; /* Maximum height constraint for both desktop and mobile */
    }

    /* --- COMMENT: Base style for BOTH layered images. Now uses height: 100% to fill its parent --- */
    .prod-diff-img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      pointer-events: none;
      background-color: rgb(var(--color-background)); /* Ensures placeholders are visible */
    }

    /* --- COMMENT: A new class to apply the clip-path, revealing the image underneath --- */
    .prod-diff-img--before {
      clip-path: inset(0 50% 0 0);
    }

    /* --- COMMENT: Style for the new INVISIBLE range slider that controls the effect --- */
    .prod-diff-slider-range {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      margin: 0;
      opacity: 0;
      cursor: grab;
      z-index: var(--z-fixed);
    }
    .prod-diff-slider-range:active { cursor: grabbing; }

    /* --- COMMENT: Style for the VISIBLE divider, now completely transparent --- */
    .prod-diff-slider-divider {
      position: absolute;
      top: 0; bottom: 0;
      left: 50%;
      width: var(--space-mini);
      background-color: transparent; /* Made completely transparent */
      transform: translateX(-50%);
      pointer-events: none;
      z-index: var(--z-dropdown);
    }

    /* --- COMMENT: The original handle style, now with a transition for the grab animation --- */
    .prod-diff-slider-handle-chevron {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: var(--z-sticky);
      transition: transform 0.2s ease;
    }

    /* --- COMMENT: A new class added by JavaScript to create the grab animation --- */
    .prod-diff-slider-handle-chevron.dragging {
      transform: translate(-50%, -50%) scale(0.9);
    }

    .prod-diff-slider-handle-chevron svg { transition: all 0.2s ease; }

    /* --- COMMENT: Styles for the product info text boxes (background removed) --- */
    .prod-diff-product-info {
      position: absolute;
      bottom: var(--space-3xl);
      padding: var(--space-lg) var(--space-2xl);
      max-width: 300px;
      border-radius: var(--space-sm);
    }
    .prod-diff-product-info.left { left: var(--space-3xl); text-align: left; }
    .prod-diff-product-info.right { right: var(--space-3xl); text-align: right; }

    /* --- COMMENT: Mobile responsive styles for product info --- */
    @media (max-width: 768px) {
      .prod-diff-product-info {
        padding: var(--space-md) var(--space-xl);
        bottom: var(--space-2xl);
        max-width: 200px; /* Key change from reference code to prevent overlap */
      }

      .prod-diff-product-info.left {
        left: var(--space-lg);
        bottom: 0vw; /* Consistent vertical positioning */
      }

      .prod-diff-product-info.right {
        right: var(--space-lg);
        bottom: 0vw; /* Consistent vertical positioning */
      }

      .prod-diff-product-name {
        font-size: var(--tm-b-2-size);
        line-height: var(--tm-b-2-line-height);
      }
    }

    .prod-diff-product-name {
      font-family: var(--font-body-family);
      font-size: var(--t-b-2-size);
      font-weight: var(--t-b-2-weight);
      margin: 0 0 var(--space-sm) 0;
      color: var(--text);
    }
    .prod-diff-product-price .prod-diff-price {
      font-family: var(--font-body-family);
      color: var(--text);
  }

    /* --- COMMENT: Styles for default Before/After labels when no products are selected --- */
    .prod-diff-default-labels {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: var(--z-content-elevated);
      pointer-events: none;
    }
    .prod-diff-default-labels.before-label {
      left: var(--space-3xl);
    }
    .prod-diff-default-labels.after-label {
      right: var(--space-3xl);
    }
    .prod-diff-default-label {
      font-family: var(--font-body-family);
      font-size: var(--t-b-2-size);
      font-weight: var(--t-b-2-weight);
      color: var(--text);
      background: rgba(255, 255, 255, 0.9);
      padding: var(--space-xl) var(--space-3xl);
      border-radius: var(--space-md);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-transform: uppercase;
      letter-spacing: var(--space-tiny);
    }
    @media screen and (max-width: 749px) {
      .prod-diff-default-label {
        font-size: var(--tm-b-2-size);
        font-weight: var(--tm-b-2-weight);
        padding: var(--space-md) var(--space-2xl);
      }

    }
</style>

{%- comment -%} Assign product and image variables at the top for cleaner code {%- endcomment -%}
{%- assign left_product = all_products[section.settings.left_product] -%}
{%- assign right_product = all_products[section.settings.right_product] -%}
{%- assign image_before = left_product.featured_image -%}
{%- assign image_after = right_product.featured_image -%}
{%- assign image_for_sizing = image_before | default: image_after -%}
{%- assign max_aspect_ratio = 0 -%}
{%- if image_for_sizing != blank -%}
  {%- assign max_aspect_ratio = image_for_sizing.aspect_ratio -%}
{%- endif -%}

{% if section.settings.enabled %}
  <section class="prod-diff-section">
    {%- comment -%}
      The container no longer needs a separate style tag for its height.
      It now uses the same variable as the main section.
    {%- endcomment -%}
    <div
      class="prod-diff-container"
      data-section-id="{{ section.id }}"
      style="
        {%- comment -%} The height calculation now has a fallback of 60vh to prevent collapsing, with max height constraint {%- endcomment -%}
        {%- if max_aspect_ratio > 0 -%}
          height: min({{ 100 | divided_by: max_aspect_ratio }}vw, 80vh);
        {%- else -%}
          height: 60vh;
        {%- endif -%}
        max-height: 80vh; /* Maximum height constraint for both desktop and mobile */
      "
    >
      {%- comment -%}
        The structure is now two layered images instead of two side-by-side wrappers.
        Each layer checks for its own image and falls back to a placeholder if needed.
      {%- endcomment -%}

      {% if image_after != blank %}
        <img
          srcset="
            {%- assign widths = '600,1200,1800,2400' | split: ',' -%}
            {%- for width in widths -%}
              {%- assign width_num = width | plus: 0 -%}
              {%- if image_after.width > width_num -%}{{ image_after | image_url: width: width }} {{ width }}w,{%- endif -%}
            {%- endfor -%}
            {{ image_after | image_url }} {{ image_after.width }}w
          "
          sizes="calc(100vw - 2rem)"
          src="{{ image_after | image_url: width: 1800 }}"
          class="prod-diff-img"
          alt="{{ image_after.alt | escape }}"
          width="{{ image_after.width }}"
          height="{{ image_after.width | divided_by: image_after.aspect_ratio | round }}"
          loading="eager"
        >
      {% else %}
        {{ 'image' | placeholder_svg_tag: 'prod-diff-img' }}
      {% endif %}

      <div id="BeforeImage-{{ section.id }}" class="prod-diff-img prod-diff-img--before">
        {% if image_before != blank %}
          <img
            srcset="
              {%- assign widths = '600,1200,1800,2400' | split: ',' -%}
              {%- for width in widths -%}
                {%- assign width_num = width | plus: 0 -%}
                {%- if image_before.width > width_num -%}{{ image_before | image_url: width: width }} {{ width }}w,{%- endif -%}
              {%- endfor -%}
              {{ image_before | image_url }} {{ image_before.width }}w
            "
            sizes="calc(100vw - 2rem)"
            src="{{ image_before | image_url: width: 1800 }}"
            class="prod-diff-img"
            alt="{{ image_before.alt | escape }}"
            width="{{ image_before.width }}"
            height="{{ image_before.width | divided_by: image_before.aspect_ratio | round }}"
            loading="eager"
          >
        {% else %}
          {{ 'image' | placeholder_svg_tag: 'prod-diff-img' }}
        {% endif %}
      </div>

      <div id="Divider-{{ section.id }}" class="prod-diff-slider-divider">
        <div id="Handle-{{ section.id }}" class="prod-diff-slider-handle-chevron">
          <svg width="137" height="51" viewBox="0 0 137 51" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="0.5" y="0.5" width="136" height="50" rx="4.5" stroke="var(--text, #000)"/>
             <path d="M112.451 26.5824L104.571 33.4767C103.642 34.2903 102.188 33.6291 102.188 32.3943V18.6058C102.187 18.3294 102.267 18.0588 102.416 17.8265C102.566 17.5941 102.779 17.4098 103.031 17.2955C103.283 17.1813 103.562 17.1421 103.835 17.1825C104.109 17.2229 104.364 17.3412 104.572 17.5233L112.45 24.4176C112.604 24.5525 112.728 24.7189 112.813 24.9056C112.898 25.0923 112.941 25.295 112.941 25.5C112.941 25.7051 112.898 25.9077 112.813 26.0944C112.728 26.2811 112.604 26.4475 112.450 26.5824H112.451Z" fill="var(--text, #000)"/>
             <path d="M24.5487 26.5824L32.4291 33.4767C33.3577 34.2903 34.8125 33.6291 34.8125 32.3943V18.6058C34.8127 18.3294 34.7333 18.0588 34.5837 17.8265C34.4342 17.5941 34.2208 17.4098 33.9691 17.2955C33.7175 17.1813 33.4383 17.1421 33.1649 17.1825C32.8915 17.2229 32.6355 17.3412 32.4277 17.5233L24.5502 24.4176C24.3958 24.5525 24.272 24.7189 24.1872 24.9056C24.1025 25.0923 24.0586 25.295 24.0586 25.5C24.0586 25.7051 24.1025 25.9077 24.1872 26.0944C24.272 26.2811 24.3958 26.4475 24.5502 26.5824H24.5487Z" fill="var(--text, #000)"/>
          </svg>
        </div>
      </div>

      <input
        type="range"
        min="0"
        max="100"
        value="50"
        id="Slider-{{ section.id }}"
        class="prod-diff-slider-range"
        aria-label="Image comparison slider"
      >

      {% if section.settings.product_name_enabled %}
        {% if left_product %}
          <div class="prod-diff-product-info left">
            <h3 class="prod-diff-product-name">{{ left_product.title }}</h3>
            <div class="prod-diff-product-price">
              {%- render 'price',
                product: left_product,
                price_class: 'prod-diff-price',
                font_size_desktop: 'var(--t-b-2-size)',
                font_size_mobile: 'var(--tm-b-2-size)',
                font_weight_desktop: 'var(--t-b-2-weight)',
                font_weight_mobile: 'var(--t-b-2-weight)',
                line_height_desktop: 'var(--t-b-2-line-height)',
                line_height_mobile: 'var(--tm-b-2-line-height)'
              -%}
            </div>
          </div>
        {% elsif image_before == blank %}
          <div class="prod-diff-product-info left default-label">
            <h3 class="prod-diff-product-name">Left</h3>
          </div>
        {% endif %}
        {% if right_product %}
          <div class="prod-diff-product-info right">
            <h3 class="prod-diff-product-name">{{ right_product.title }}</h3>
            <div class="prod-diff-product-price">
              {%- render 'price',
                product: right_product,
                price_class: 'prod-diff-price',
                font_size_desktop: 'var(--t-b-2-size)',
                font_size_mobile: 'var(--tm-b-2-size)',
                font_weight_desktop: 'var(--t-b-2-weight)',
                font_weight_mobile: 'var(--t-b-2-weight)',
                line_height_desktop: 'var(--t-b-2-line-height)',
                line_height_mobile: 'var(--tm-b-2-line-height)'
              -%}
            </div>
          </div>
        {% elsif image_after == blank %}
          <div class="prod-diff-product-info right default-label">
            <h3 class="prod-diff-product-name">Right</h3>
          </div>
        {% endif %}
      {% else %}
        {%- comment -%} Show Left/Right labels when product names are disabled and using default images {%- endcomment -%}
        {% if image_before == blank %}
          <div class="prod-diff-product-info left default-label">
            <h3 class="prod-diff-product-name">Left</h3>
          </div>
        {% endif %}
        {% if image_after == blank %}
          <div class="prod-diff-product-info right default-label">
            <h3 class="prod-diff-product-name">Right</h3>
          </div>
        {% endif %}
      {% endif %}
    </div>
  </section>
{% endif %}

{%- comment -%}
  The original complex script was the source of the theme conflict.
  It has been replaced by this short, simple, and isolated script that
  is much more reliable and avoids conflicts.
{%- endcomment -%}
<script>
  {
    const sliderContainer = document.querySelector(`[data-section-id="{{ section.id }}"]`);
    if (sliderContainer) {
      const slider = sliderContainer.querySelector('#Slider-{{ section.id }}');
      const beforeImage = sliderContainer.querySelector('#BeforeImage-{{ section.id }}');
      const divider = sliderContainer.querySelector('#Divider-{{ section.id }}');
      const handle = sliderContainer.querySelector('#Handle-{{ section.id }}');

      if (slider && beforeImage && divider && handle) {
        // JavaScript for the grab animation is added here
        slider.addEventListener('mousedown', () => handle.classList.add('dragging'));
        slider.addEventListener('touchstart', () => handle.classList.add('dragging'));
        window.addEventListener('mouseup', () => handle.classList.remove('dragging'));
        window.addEventListener('touchend', () => handle.classList.remove('dragging'));

        // This is the new, simple logic that updates the slider visuals
        slider.addEventListener('input', (e) => {
          const value = e.target.value;
          beforeImage.style.clipPath = `inset(0 calc(100% - ${value}%) 0 0)`;
          divider.style.left = `${value}%`;
        });

        // Remove hyphens from price text
        const priceItems = sliderContainer.querySelectorAll('.prod-diff-price .price-item--regular');
        priceItems.forEach((item) => {
          if (item.textContent.includes(' - ')) {
            item.textContent = item.textContent.replace(/ - /g, ' ');
          }
        });
      }
    }
  }
</script>

{%- comment -%} The schema has been restored to include the 'Enable' checkbox and all original settings {%- endcomment -%}
{% schema %}
{
  "name": "Product Difference Slider",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable section",
      "default": true
    },
    {
      "type": "product",
      "id": "left_product",
      "label": "Left Product ('Before' Image)"
    },
    {
      "type": "product",
      "id": "right_product",
      "label": "Right Product ('After' Image)"
    },
    {
      "type": "checkbox",
      "id": "product_name_enabled",
      "label": "Enable product name",
      "default": true
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Top Padding",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Top Margin",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Bottom Margin",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Product Difference Slider",
      "settings": {
        "enabled": false
      }
    }
  ]
}
{% endschema %}
