name: Shopify Lighthouse CI

on: [push]

jobs:
  lhci:
    name: Lighthouse (PF_TESTING)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Run Shopify Lighthouse CI (with failure handling)
        id: lhci_run
        continue-on-error: true
        run: |
          echo "Running Shopify Lighthouse CI..."
          export LHCI_EXIT_CODE=0

          {
            echo "Preparing config..."
            echo "Running @shopify/lighthouse-ci-action..."
          } > lhci_output.txt

          # Run LHCI via the GitHub Action CLI
          echo "Fake LHCI run for capturing logs" >> lhci_output.txt
          echo "âœ˜ categories.accessibility failure for minScore assertion" >> lhci_output.txt
          echo "Open the report at https://storage.googleapis.com/lighthouse/report1.html" >> lhci_output.txt

          grep "âœ˜" lhci_output.txt > failed_assertions.txt || echo "No assertion failures" > failed_assertions.txt
          grep -o 'https://storage.googleapis.com[^ ]*\.report\.html' lhci_output.txt > report_urls.txt || echo "No report links found" > report_urls.txt

          if grep -qi "maximum number of 100 development themes" lhci_output.txt; then
            echo "FAILURE_TYPE=theme_limit" >> $GITHUB_ENV
          elif grep -q "âœ˜" failed_assertions.txt; then
            echo "FAILURE_TYPE=assertion" >> $GITHUB_ENV
          else
            echo "FAILURE_TYPE=infra" >> $GITHUB_ENV
          fi

      - name: Notify Slack on Failure
        if: failure()
        run: |
          ACTOR=${{ github.actor }}
          BRANCH=${{ github.ref_name }}
          COMMIT=${{ github.sha }}
          TYPE=${{ env.FAILURE_TYPE }}
          REPO_URL="https://github.com/${{ github.repository }}"
          COMMIT_URL="${REPO_URL}/commit/${COMMIT}"

          MSG="*ðŸš¨ Shopify Lighthouse CI failed!*\n"
          MSG+="*Triggered by:* \`@${ACTOR}\`\n"
          MSG+="*Branch:* \`${BRANCH}\`\n"
          MSG+="*Commit:* <${COMMIT_URL}|${COMMIT}>\n"
          MSG+="*Workflow:* \`${{ github.workflow }}\`\n\n"

          if [ "$TYPE" = "theme_limit" ]; then
            MSG+="*Reason:* ðŸ”º Shopify theme limit (100) reached â€” cannot create a new development theme.\n"
          elif [ "$TYPE" = "assertion" ]; then
            MSG+="*Failing Constraints:*\n$(cat failed_assertions.txt)\n\n"
          else
            MSG+="*Reason:* CI process failed before assertions â€” possible infra/config/auth issue.\n"
          fi

          MSG+="*Report Links:*\n$(cat report_urls.txt)"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MSG//\"/\\\"}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Actual Shopify LHCI Action
        if: always()
        uses: shopify/lighthouse-ci-action@v1
        with:
          access_token:  ${{ secrets.APIKEY }}
          store: "delhi-dev-themetest.myshopify.com"
          lhci_min_score_accessibility: 0.9
          lhci_min_score_performance: 0.7
          password: "thoolt"
