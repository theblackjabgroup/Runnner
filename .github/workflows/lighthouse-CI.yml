name: Shopify Lighthouse CI

on: [push]

jobs:
  lhci:
    name: Lighthouse CI with Slack
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Run Shopify Lighthouse CI
        id: run_lhci
        continue-on-error: true
        uses: shopify/lighthouse-ci-action@v1
        with:
          access_token: ${{ secrets.APIKEY }}
          store: "delhi-dev-themetest.myshopify.com"
          lhci_min_score_accessibility: 1.0
          lhci_min_score_performance: 0.9
          password: "thoolt"

      - name: Detect Failure Type from LHCI logs
        if: steps.run_lhci.outcome == 'failure'
        run: |
          LOG_DIR="${{ github.workspace }}/../_temp"
          LOG_FILE=$(find "$LOG_DIR" -name '*.txt' | head -n1)
          echo "Parsing LHCI logs at: $LOG_FILE"

          FAILURE_TYPE="infra"
          SCORES=""

          if grep -qi "categories.accessibility failure" "$LOG_FILE"; then
            SCORES+="Accessibility "
          fi

          if grep -qi "categories.performance failure" "$LOG_FILE"; then
            SCORES+="Performance "
          fi

          if grep -qi "maximum number of 100 development themes" "$LOG_FILE"; then
            FAILURE_TYPE="theme_limit"
          elif [ -n "$SCORES" ]; then
            FAILURE_TYPE="assertion"
          fi

          echo "FAILURE_TYPE=$FAILURE_TYPE" >> $GITHUB_ENV
          echo "SCORE_FAILURES=$SCORES" >> $GITHUB_ENV

      - name: Notify Slack
        if: steps.run_lhci.outcome == 'failure'
        run: |
          ACTOR=${{ github.actor }}
          BRANCH=${{ github.ref_name }}
          COMMIT=${{ github.sha }}
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${COMMIT}"
          WORKFLOW="${{ github.workflow }}"
          FAILURE_TYPE=${{ env.FAILURE_TYPE }}
          SCORES=${{ env.SCORE_FAILURES }}

          if [ "$FAILURE_TYPE" = "assertion" ]; then
            REASON="One or more Lighthouse assertions failed: $SCORES"
          elif [ "$FAILURE_TYPE" = "theme_limit" ]; then
            REASON="ðŸ”º Shopify theme limit (100) reached â€” cannot create a new development theme."
          else
            REASON="CI failed before assertions â€” possible infra/config issue."
          fi

          MSG=":ðŸ”º *Shopify Lighthouse CI failed!*\n"
          MSG+="*Triggered by:* \`@${ACTOR}\`\n"
          MSG+="*Branch:* \`${BRANCH}\`\n"
          MSG+="*Commit:* <${COMMIT_URL}|${COMMIT}>\n"
          MSG+="*Message:* ${COMMIT_MESSAGE}\n"
          MSG+="*Workflow:* \`${WORKFLOW}\`\n"
          MSG+="*Reason:* ${REASON}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MSG//\"/\\\"}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Manually Fail the Job
        if: steps.run_lhci.outcome == 'failure'
        run: |
          echo "Failing job after notifying Slack."
          exit 1
