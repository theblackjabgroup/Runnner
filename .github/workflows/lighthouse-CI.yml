name: Shopify Lighthouse CI

on: [push]

jobs:
  lhci:
    name: Lighthouse CI with Slack
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install LHCI CLI
        run: npm install -g @lhci/cli@0.11.x

      - name: Run LHCI and capture logs
        id: lhci
        continue-on-error: true
        run: |
          set -o pipefail
          lhci autorun > lhci_output.txt 2>&1 || echo "LHCI failed"

      - name: Detect failure type and failing scores
        if: always()
        run: |
          set -o pipefail
          echo "Parsing lhci_output.txt..."
          SCORE_FAILURES=""

          grep -q "categories.accessibility failure" lhci_output.txt && SCORE_FAILURES+="Accessibility "
          grep -q "categories.performance failure" lhci_output.txt && SCORE_FAILURES+="Performance "

          if grep -qi "maximum number of 100 development themes" lhci_output.txt; then
            echo "FAILURE_TYPE=theme_limit" >> $GITHUB_ENV
          elif [ -n "$SCORE_FAILURES" ]; then
            echo "FAILURE_TYPE=assertion" >> $GITHUB_ENV
            echo "SCORE_FAILURES=$SCORE_FAILURES" >> $GITHUB_ENV
          else
            echo "FAILURE_TYPE=infra" >> $GITHUB_ENV
          fi

      - name: Notify Slack
        if: always()
        run: |
          ACTOR=${{ github.actor }}
          BRANCH=${{ github.ref_name }}
          COMMIT=${{ github.sha }}
          TYPE=${{ env.FAILURE_TYPE }}
          SCORES="${{ env.SCORE_FAILURES }}"
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          REPO_URL="https://github.com/${{ github.repository }}"
          COMMIT_URL="${REPO_URL}/commit/${COMMIT}"

          MSG="*ðŸš¨ Shopify Lighthouse CI failed!*\n"
          MSG+="*Triggered by:* \`@${ACTOR}\`\n"
          MSG+="*Branch:* \`${BRANCH}\`\n"
          MSG+="*Commit:* <${COMMIT_URL}|${COMMIT}>\n"
          MSG+="*Message:* ${COMMIT_MESSAGE}\n"
          MSG+="*Workflow:* \`${{ github.workflow }}\`\n\n"

          if [ "$TYPE" = "theme_limit" ]; then
            MSG+="*Reason:* ðŸ”º Shopify theme limit (100) reached.\n"
          elif [ "$TYPE" = "assertion" ]; then
            MSG+="*Failing Score(s):* ${SCORES}\n\n"
          else
            MSG+="*Reason:* CI failed before assertions â€” possible infra/config issue.\n"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"${MSG//\"/\\\"}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Manually Fail if Needed
        if: ${{ env.FAILURE_TYPE == 'assertion' || env.FAILURE_TYPE == 'theme_limit' }}
        run: |
          echo "CI failed due to: $FAILURE_TYPE"
          exit 1
