{%- comment -%}
  Product Section - Desktop Version

  Complete desktop product page including:
  - Product gallery with thumbnails
  - Product information and variants
  - Tab system (Description, Details, Sizing)
  - Add to cart functionality
  - Delivery options
  - Quantity selector
  - Pricing and savings
  - Pickup availability

  Parameters:
  - product: Product object (required)
  - section: Section object for settings and blocks (required)
{%- endcomment -%}

<section
  class="product-section product-section-container color-{{ section.settings.color_scheme }} section-{{ section.id }}-padding hidden lg:!flex lg:flex-row gap-4 lg:gap-8"
  role="main"
  aria-labelledby="product-title"
>
  {%- comment -%} Left: Image Gallery {%- endcomment -%}
  <div class="product-gallery w-1/2" role="region" aria-label="Product images">
    <div
      class="gallery-wrapper gallery-wrapper-sticky sticky top-[80px] h-[calc(100vh-80px)]"
    >
      <div class="gallery-track w-full h-full relative" data-gallery-track role="img" aria-live="polite">
        {%- if product.media.size >= 0 -%}
          {%- for media in product.media -%}
            <div
              class="gallery-item absolute inset-0 w-full h-full {% if forloop.first %}is-active{% endif %}"
              data-index="{{ forloop.index0 }}"
              data-media-id="{{ media.id }}"
              {%- assign variant_tags = '' -%}
              {%- if media.alt contains 'variant:' -%}
                {%- assign variant_part = media.alt | split: 'variant:' | last -%}
                {%- assign variant_tags = variant_part | split: ',' -%}
                data-variant-options="{{ variant_tags | join: '|' | downcase }}"
              {%- endif -%}
              id="gallery-item-{{ forloop.index0 }}"
              {% if forloop.first %}
                aria-current="true"
              {% endif %}
            >
              {% if media.media_type == 'image' %}
                <img
                  srcset="
                    {%- if media.width >= 375 -%}{{ media | image_url: width: 375 }} 375w,{%- endif -%}
                    {%- if media.width >= 750 -%}{{ media | image_url: width: 750 }} 750w,{%- endif -%}
                    {%- if media.width >= 1070 -%}{{ media | image_url: width: 1070 }} 1070w,{%- endif -%}
                    {%- if media.width >= 1500 -%}{{ media | image_url: width: 1500 }} 1500w,{%- endif -%}
                    {{ media | image_url }} {{ media.width }}w
                  "
                  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 60vw, 50vw"
                  src="{{ media | image_url: width: 1500 }}"
                  alt="{{ media.alt | escape | default: product.title | append: ' - Image ' | append: forloop.index }}"
                  class="w-full h-full object-cover"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  fetchpriority="{% if forloop.first %}high{% else %}auto{% endif %}"
                  decode="async"
                  width="{{ media.width }}"
                  height="{{ media.height }}"
                >
              {% elsif media.media_type == 'video' %}
                {{
                  media
                  | video_tag:
                    autoplay: true,
                    loop: true,
                    muted: true,
                    playsinline: true,
                    controls: true,
                    class: 'w-full h-full object-cover',
                    role: 'img'
                }}
              {% elsif media.media_type == 'model' %}
                <div class="product-model-viewer w-full h-full relative">
                  <svg
                    class="model-viewer-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                  </svg>
                  {{ media | model_viewer_tag: image_size: '1500x' }}
                </div>
              {% endif %}
            </div>
          {%- endfor -%}
        {%- endif -%}

        <!-- Add vertical image strip -->
        <div
          class="image-strip-container image-strip-container-fixed"
          role="tablist"
          aria-label="Product image thumbnails"
        >
          <div class="image-strip" id="desktop-image-strip">
            {%- for media in product.media -%}
              <button
                class="strip-image-wrapper {% if forloop.first %}active{% endif %}"
                data-strip-index="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                {%- assign variant_tags = '' -%}
                {%- if media.alt contains 'variant:' -%}
                  {%- assign variant_part = media.alt | split: 'variant:' | last -%}
                  {%- assign variant_tags = variant_part | split: ',' -%}
                  data-variant-options="{{ variant_tags | join: '|' | downcase }}"
                {%- endif -%}
                role="tab"
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                aria-controls="gallery-item-{{ forloop.index0 }}"
                aria-label="View {{ media.alt | escape | default: 'product image' }} {{ forloop.index }}"
                tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
              >
                {% if media.media_type == 'video' %}
                  <div class="relative w-full h-full">
                    <img
                      srcset="
                        {%- if media.preview_image.width >= 75 -%}{{ media.preview_image | image_url: width: 75 }} 75w,{%- endif -%}
                        {%- if media.preview_image.width >= 150 -%}{{ media.preview_image | image_url: width: 150 }} 150w,{%- endif -%}
                        {%- if media.preview_image.width >= 300 -%}{{ media.preview_image | image_url: width: 300 }} 300w,{%- endif -%}
                        {{ media.preview_image | image_url }} {{ media.preview_image.width }}w
                      "
                      sizes="150px"
                      src="{{ media.preview_image | image_url: width: 150 }}"
                      alt="{{ media.alt | escape | default: product.title | append: ' thumbnail ' | append: forloop.index }}"
                      class="strip-image"
                      loading="lazy"
                      decode="async"
                      width="150"
                      height="{{ 150 | divided_by: media.preview_image.aspect_ratio | ceil }}"
                      aria-hidden="true"
                    >
                    <span
                      class="video-play-icon absolute inset-0 flex items-center justify-center pointer-events-none"
                      aria-hidden="true"
                    >
                      <svg width="32" height="32" fill="none" viewBox="0 0 32 32">
                        <circle cx="16" cy="16" r="16" fill="rgba(0,0,0,0.5)"/>
                        <polygon points="13,10 24,16 13,22" fill="white"/>
                      </svg>
                    </span>
                  </div>
                {% elsif media.media_type == 'model' %}
                  <div class="relative w-full h-full">
                    <img
                      srcset="
                        {%- if media.preview_image.width >= 75 -%}{{ media.preview_image | image_url: width: 75 }} 75w,{%- endif -%}
                        {%- if media.preview_image.width >= 150 -%}{{ media.preview_image | image_url: width: 150 }} 150w,{%- endif -%}
                        {%- if media.preview_image.width >= 300 -%}{{ media.preview_image | image_url: width: 300 }} 300w,{%- endif -%}
                        {{ media.preview_image | image_url }} {{ media.preview_image.width }}w
                      "
                      sizes="150px"
                      src="{{ media.preview_image | image_url: width: 150 }}"
                      alt="{{ media.alt | escape | default: product.title | append: ' 3D model thumbnail ' | append: forloop.index }}"
                      class="strip-image"
                      loading="lazy"
                      decode="async"
                      width="150"
                      height="{{ 150 | divided_by: media.preview_image.aspect_ratio | ceil }}"
                      aria-hidden="true"
                    >
                    <span
                      class="video-play-icon absolute inset-0 flex items-center justify-center pointer-events-none"
                      aria-hidden="true"
                    >
                      <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10" fill="rgba(0,0,0,0.5)"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                      </svg>
                    </span>
                  </div>
                {% else %}
                  <img
                    srcset="
                      {%- if media.width >= 75 -%}{{ media | image_url: width: 75 }} 75w,{%- endif -%}
                      {%- if media.width >= 150 -%}{{ media | image_url: width: 150 }} 150w,{%- endif -%}
                      {%- if media.width >= 300 -%}{{ media | image_url: width: 300 }} 300w,{%- endif -%}
                      {{ media | image_url }} {{ media.width }}w
                    "
                    sizes="150px"
                    src="{{ media | image_url: width: 150 }}"
                    alt="{{ media.alt | escape | default: product.title | append: ' thumbnail ' | append: forloop.index }}"
                    class="strip-image"
                    loading="lazy"
                    decode="async"
                    width="150"
                    height="{{ 150 | divided_by: media.aspect_ratio | ceil }}"
                    aria-hidden="true"
                  >
                {% endif %}
              </button>
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  {%- comment -%} Right: Product Details {%- endcomment -%}
  <div class="product-details w-1/2 mx-2" role="region" aria-labelledby="product-title">
    <div
      class="details-inner product-info-sticky sticky top-[80px] flex flex-col"
    >
      {%- comment -%} Header {%- endcomment -%}
      <div class="product-header w-[80%] space-y-8">
        <div class="header-top flex flex-col gap-4">
          <div class="product-status flex items-center gap-4" role="status" aria-live="polite">
            {% if product.available != true %}
              {% render 'sold-out-badge', class: 'inline-flex items-center text-[14px] tracking-wider uppercase' %}
            {% endif %}
          </div>
          <h1
            id="product-title"
            class="text-[42px] pb-10 product-title-text scroll-fade-trigger scroll-fade-up"
          >
            {{ product.title }}
          </h1>

          {%- comment -%} Product Variant {%- endcomment -%}
          {%- assign color_option = product.options_with_values | where: 'name', 'Color' | first -%}
          {%- if color_option and color_option.values.size > 0 -%}
            <fieldset class="product-variants my-4" role="group" aria-labelledby="color-legend">
              <legend id="color-legend" class="flex items-center gap-2">
                <span
                  class="inline-block text-[14px] font-medium product-body-text"
                  >SELECT COLOR:</span
                >
                <span
                  class="active-color text-[14px] font-medium uppercase product-body-text"
                  data-active-color
                  aria-live="polite"
                >
                  {{- color_option.values | first -}}
                </span>
              </legend>
              <div class="product-color-options flex gap-3 p-2" role="radiogroup" aria-labelledby="color-legend">
                {%- for value in color_option.values -%}
                  <button
                    type="button"
                    class="color-swatch rounded-full hover:scale-110 transition-transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    style="background-color: {{ value | handleize }};"
                    data-option-value="{{ value | escape }}"
                    role="radio"
                    aria-checked="{% if forloop.first %}true{% else %}false{% endif %}"
                    aria-label="Color: {{ value }}"
                    tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
                  >
                    <span class="sr-only">{{ value }}</span>
                  </button>
                {%- endfor -%}
              </div>
            </fieldset>
          {%- endif -%}
        </div>
      </div>

      {% comment %} tabs  {% endcomment %}
      {% render 'product-tabs-desktop', product: product, blocks: section.blocks %}

      {%- comment -%} bottom utility {%- endcomment -%}

      <div
        class="size-price-selector flex flex-col gap-6"
        role="region"
        aria-label="Product options and purchase"
      >
        <!-- DELIVERY SECTION -->
        {%- for block in section.blocks -%}
          {%- if block.type == 'delivery_address' -%}
            <div
              class="flex justify-between items-start py-4 details-border-bottom"
              {{ block.shopify_attributes }}
            >
              {% if customer and customer.default_address %}
                <!-- Logged-in: Show saved address -->
                <div role="group" aria-labelledby="delivery-heading">
                  <div id="delivery-heading" class="font-medium uppercase">DELIVER TO</div>
                  <div class="text-sm leading-relaxed" aria-describedby="delivery-heading">
                    {{ customer.default_address | format_address }}
                  </div>
                </div>
                <button
                  class="delivery-change-btn px-2 py-0 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  aria-label="Change delivery address"
                  aria-describedby="current-address"
                >
                  CHANGE
                </button>
                <span id="current-address" class="sr-only"
                  >Current address: {{ customer.default_address | format_address -}}
                </span>
              {% else %}
                <!-- Guest: Show login prompt -->
                <div role="group" aria-labelledby="delivery-heading-guest">
                  <div id="delivery-heading-guest" class="uppercase">DELIVER TO</div>
                  <div class="secondary-text-color">
                    Please
                    <a
                      href="{{ routes.account_login_url }}"
                      class="underline text-blue-600"
                      aria-describedby="login-help"
                      >log in</a
                    >
                    to set your delivery address.
                  </div>
                  <span id="login-help" class="sr-only">Login required to save and manage delivery addresses</span>
                </div>
                <button
                  class="delivery-change-btn px-2 py-0 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  class="details-summary-border"
                  aria-label="Set delivery address"
                >
                  CHANGE
                </button>
              {% endif %}
            </div>
          {%- endif -%}
        {%- endfor -%}

        <!-- QUANTITY SELECTOR -->
        {%- for block in section.blocks -%}
          {%- if block.type == 'quantity_selector' -%}
            <div
              class="flex justify-between items-center details-border-both"
              {{ block.shopify_attributes }}
            >
              <label for="Quantity-{{ product.selected_or_first_available_variant.id }}" class="font-medium uppercase"
                >QUANTITY SELECTOR</label
              >
              {% render 'quantity-input',
                variant: product.selected_or_first_available_variant,
                mobile: false,
                min: 1,
                for_cart: false
              %}
            </div>
          {%- endif -%}
        {%- endfor -%}

        <!-- SIZE/DENOMINATION SELECTOR (no color) -->
        {% render 'size-variant-picker', product: product, mobile: false %}
        {% if product.gift_card? %}
          <div class="price-container-border">
            {% render 'gift-card-recipient-form', product: product, form: form, section: section %}
          </div>
        {% endif %}

        <!-- PRICE + ACTIONS -->
        <div
          class="flex justify-between items-center pt-4 stock-container"
        >
          <!-- Price + Compare at Price -->
          <div
            class="flex flex-col"
            class="product-text-small product-text-small"
            role="region"
            aria-labelledby="price-heading"
          >
            <span class="sr-only">Product pricing</span>
            <div class="flex items-center price-gap">
              {% render 'price',
                product: product,
                use_variant: true,
                show_compare_at_price: true,
                font_weight_desktop: section.settings.product_price_font_weight,
                font_size_desktop: 'var(--t-b-1-size)',
                price_class: 'main-product-price'
              %}
            </div>

            <div
              id="savings-info"
              class="font-medium {% unless product.selected_or_first_available_variant.compare_at_price and product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}hidden{% endunless %}"
              class="sale-price-color"
              role="status"
              aria-live="polite"
            >
              {% if product.selected_or_first_available_variant.compare_at_price
                and product.selected_or_first_available_variant.compare_at_price
                  > product.selected_or_first_available_variant.price
              %}
                Save
                {{
                  product.selected_or_first_available_variant.compare_at_price
                  | minus: product.selected_or_first_available_variant.price
                  | money
                }}
                (
                {{
                  product.selected_or_first_available_variant.compare_at_price
                  | minus: product.selected_or_first_available_variant.price
                  | times: 100
                  | divided_by: product.selected_or_first_available_variant.compare_at_price
                -}}
                % off)
              {% endif %}
            </div>
          </div>

          <!-- Add to Cart -->
          <div class="flex gap-2 flex-col">
            <div class="flex gap-2">
              {% if product.available %}
                <!-- ADD TO CART form -->
                <form
                  method="post"
                  action="{{ routes.cart_add_url }}"
                  id="add-to-cart-form"
                  role="form"
                  aria-labelledby="add-to-cart-heading"
                >
                  <span id="add-to-cart-heading" class="sr-only">Add product to cart</span>
                  <input
                    type="hidden"
                    name="id"
                    id="variant-id"
                    value="{{ product.selected_or_first_available_variant.id }}"
                    aria-label="Selected variant ID"
                  >
                  <input type="hidden" name="quantity" value="1" aria-label="Quantity">
                  <div id="add-to-cart-btn">
                    {% render 'tertiary-button',
                      button_text: 'ADD TO CART',
                      button_font_size: 'var(--t-b-1-size)',
                      font_weight: 'var(--t-b-1-weight)',
                      button_line_height: 'var(--t-b-1-line-height)',
                      mobile_font_size: 'var(--tm-b-2-size)',
                      mobile_font_weight: 'var(--tm-b-2-weight)',
                      mobile_line_height: 'var(--tm-b-2-line-height)',
                      tertiary_class: 'add-to-cart-tertiary-btn',
                      button_type: 'button',
                      button_width: '370px',
                      button_height: '50px',
                      data_attributes: 'aria-describedby="add-to-cart-description"'
                    %}
                  </div>
                  <span id="add-to-cart-description" class="sr-only">Add this product to your shopping cart</span>
                </form>
              {% else %}
                <!-- SOLD OUT button -->
                <button
                  class="text-4xl px-6 py-3 cursor-not-allowed sold-out-button product-text-large"
                  type="button"
                  disabled
                  aria-label="Product is sold out"
                  aria-describedby="sold-out-description"
                >
                  SOLD OUT
                </button>
                <span id="sold-out-description" class="sr-only">This product is currently out of stock</span>
              {% endif %}
            </div>
          </div>
        </div>
        {%- for block in section.blocks -%}
          {%- if block.type == 'pickup_availability' -%}
            <div
              class="pickup-availability-container mt-4 full-width-button full-width-button"
              role="region"
              aria-label="Pickup availability"
            >
              {% render 'pickup-availability', product_variant: product.selected_or_first_available_variant %}
              {{ 'component-pickup-availability.css' | asset_url | stylesheet_tag }}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  </div>
</section>
